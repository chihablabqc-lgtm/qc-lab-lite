<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QC Lab Lite v3.2</title>
<style>
:root{--bg:#f6f7f9;--ink:#111;--mut:#666;--bd:#dcdfe4;--acc:#0f172a;--ok:#eaffea;--nc:#ffecec;--chip:#eef2ff;--warn:#fff7e6}
*{box-sizing:border-box}html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);z-index:10}
.container{max-width:1180px;margin:0 auto;padding:10px}
.btn{padding:8px 12px;border:1px solid #cbd5e1;border-radius:10px;background:#fff;cursor:pointer}
.btn-primary{background:var(--acc);color:#fff;border:none}
.btn-danger{background:#c62828;color:#fff;border:none}
.btn-ghost{background:transparent;border:1px dashed #cbd5e1}
.card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px}
.grid{display:grid;gap:10px}.g3{grid-template-columns:repeat(3,1fr)}.g2{grid-template-columns:repeat(2,1fr)}.g4{grid-template-columns:repeat(4,1fr)}
.input,select,textarea{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:10px;background:#fff}
table{width:100%;border-collapse:collapse}th,td{padding:8px;border-top:1px solid #e5e7eb;text-align:left;font-size:14px}
th{background:#f8fafc}.muted{color:#666;font-size:12px}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#fff;border-radius:14px;border:1px solid var(--bd);max-width:1120px;width:95vw;max-height:90vh;overflow:auto;padding:12px}
.logoBox{border:1px solid var(--bd);border-radius:10px;min-height:70px;min-width:220px;display:flex;align-items:center;justify-content:center;background:#fff}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 0}
.chip{background:var(--chip);border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;font-size:12px}
.okbg{background:var(--ok)}.ncbg{background:var(--nc)}.warnbg{background:var(--warn)}
.tbl{border:1px solid var(--bd);border-radius:10px;overflow:auto}
.tbl table th, .tbl table td{white-space:nowrap}
.param-ok{background:var(--ok)}.param-bad{background:var(--nc)}
@media print{header,.no-print{display:none!important}body{background:#fff}.card{border:none;padding:0}th,td{border:1px solid #000}th{background:#fff}}
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
    <div style="display:flex;align-items:center;gap:10px">
      <img id="labLogoSmall" style="max-height:40px;max-width:180px;display:none"/>
      <div>
        <div id="labNameHdr" style="font-weight:700">QC Lab Lite</div>
        <div id="labMetaHdr" class="muted"></div>
      </div>
    </div>
    <div class="no-print" style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
      <button class="btn" id="btnLang">FR</button>
      <button class="btn" id="btnClients">Clients</button>
      <button class="btn" id="btnCatalog">Catalogue</button>
      <button class="btn" id="btnSettings">IdentitÃ© labo</button>
      <button class="btn" id="btnExport">Exporter CSV</button>
      <button class="btn" id="btnBackup">Sauvegarder</button>
      <button class="btn" id="btnRestore">Restaurer</button>
      <button class="btn btn-primary" id="btnNew">+ Nouvel Ã©chantillon</button>
    </div>
  </div>
</header>

<main class="container grid" style="gap:12px">
  <div class="grid g3">
    <div class="card"><div class="muted" data-i="stats.samples">Ã‰chantillons</div><div id="statTotal" style="font-weight:700">0</div></div>
    <div class="card"><div class="muted" data-i="stats.soon">Ã‰chÃ©ance â‰¤48h</div><div id="statSoon" style="font-weight:700">0</div></div>
    <div class="card"><div class="muted" data-i="stats.year">AnnÃ©e courante</div><div id="statYear" style="font-weight:700">0</div></div>
  </div>

  <div class="grid g3">
    <div><div class="muted" data-i="search">Recherche</div><input class="input" id="q" placeholder="Code, client, produit, service"/></div>
    <div><div class="muted" data-i="service">Service</div><select class="input" id="fService"><option data-i="all">Tous</option><option>Physico-chimie</option><option>Microbiologie</option></select></div>
    <div><div class="muted" data-i="priority">PrioritÃ©</div><select class="input" id="fPriority"><option data-i="allf">Toutes</option><option>Normale</option><option>Urgente</option><option>Critique</option></select></div>
  </div>

  <div class="card tbl" style="padding:0">
    <table>
      <thead><tr>
        <th data-i="code">Code</th><th data-i="intcode">Code interne</th><th data-i="client">Client</th><th data-i="prodsvc">Produit/Service</th>
        <th data-i="sampler">PrÃ©leveur</th><th data-i="recv">RÃ©ception</th>
        <th data-i="mfg">Fabrication</th><th data-i="exp">Expiration</th>
        <th data-i="due">Ã‰chÃ©ance</th><th data-i="prio">PrioritÃ©</th><th class="no-print" style="text-align:right" data-i="actions">Actions</th>
      </tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</main>

<!-- Ã‰CHANTILLON -->
<div class="modal-bg" id="mSample"><div class="modal">
  <div class="row"><div style="font-weight:600" id="mSampleTitle" data-i="newsample">Nouvel Ã©chantillon</div><button class="btn no-print" onclick="closeM('mSample')">âœ•</button></div>
  <form id="sampleForm">
    <div class="grid g3">
      <div><div class="muted" data-i="code">Code</div><input class="input" id="s_code" placeholder="auto PH/MC" readonly/></div>
      <div><div class="muted" data-i="intcode">Code interne</div><input class="input" id="s_intcode" placeholder="auto INT/AAAA" readonly/></div>
      <div><div class="muted" data-i="client">Client</div><div style="display:flex;gap:6px"><select class="input" id="s_client"></select><button type="button" class="btn" onclick="openM('mClients')" data-i="new">Nouveau</button></div></div>

      <div><div class="muted" data-i="clientaddr">Adresse client</div><input class="input" id="s_clientAddr"/></div>
      <div><div class="muted" data-i="product">Produit</div><select class="input" id="s_product"></select></div>
      <div><div class="muted" data-i="service">Service</div><select class="input" id="s_service"><option value="">â€”</option><option>Physico-chimie</option><option>Microbiologie</option></select></div>

      <div><div class="muted" data-i="brand">Nom commercial</div><input class="input" id="s_brand"/></div>
      <div><div class="muted" data-i="qty">Poids / QtÃ©</div><input class="input" id="s_qty"/></div>
      <div><div class="muted" data-i="temp">TempÃ©rature (Â°C)</div><input class="input" id="s_temp"/></div>

      <div><div class="muted" data-i="loc">Lieu prÃ©lÃ¨vement</div><input class="input" id="s_loc"/></div>
      <div><div class="muted" data-i="sampler">PrÃ©leveur</div><select class="input" id="s_sampler"><option data-i="client">Client</option><option data-i="labtech">Technicien labo</option></select></div>
      <div><div class="muted" data-i="recv">RÃ©ception</div><input type="date" class="input" id="s_recv"/></div>

      <div><div class="muted">Heure rÃ©ception</div><input type="time" class="input" id="s_recvTime"/></div>
      <div><div class="muted" data-i="mfg">Fabrication (opt.)</div><input type="date" class="input" id="s_mfg"/></div>
      <div><div class="muted" data-i="exp">Expiration (opt.)</div><input type="date" class="input" id="s_exp"/></div>

      <div><div class="muted" data-i="due">Ã‰chÃ©ance</div><input type="date" class="input" id="s_due"/></div>
      <div><div class="muted" data-i="priority">PrioritÃ©</div><select class="input" id="s_priority"><option>Normale</option><option>Urgente</option><option>Critique</option></select></div>
      <div style="grid-column:1/span 3"><div class="muted" data-i="notes">Notes</div><textarea class="input" rows="2" id="s_notes"></textarea></div>
    </div>

    <div class="row" style="margin-top:8px"><div style="font-weight:600" data-i="tests">Tests</div>
      <div class="no-print" style="display:flex;gap:6px">
        <button type="button" class="btn" onclick="addTest()" data-i="addtest">+ Test</button>
        <button type="button" class="btn" onclick="loadParams()" data-i="loadparams">Charger paramÃ¨tres</button>
      </div>
    </div>
    <div id="testsZone" class="grid" style="margin-top:6px"></div>

    <div class="row no-print" style="justify-content:flex-end;margin-top:10px">
      <button type="button" class="btn" onclick="closeM('mSample')" data-i="cancel">Annuler</button>
      <button class="btn btn-primary" type="submit" data-i="save">Enregistrer</button>
    </div>
  </form>
</div></div>

<!-- RAPPORT -->
<div class="modal-bg" id="mReport"><div class="modal">
  <div class="row"><div style="font-weight:600" data-i="report">Rapport</div>
    <div class="no-print" style="display:flex;gap:6px">
      <button class="btn" onclick="window.print()" data-i="printpdf">Imprimer / PDF</button>
      <button class="btn" onclick="exportWord()" data-i="exportword">Exporter Word</button>
      <button class="btn" onclick="openM('mValidator')" id="btnValData">DonnÃ©es validateur</button>
      <button class="btn btn-primary" id="btnValidate" onclick="validateReport()" data-i="validate">Valider rapport</button>
      <button class="btn btn-danger" id="btnUnvalidate" onclick="unvalidateReport()" style="display:none" data-i="unvalidate">Annuler validation</button>
      <button class="btn" onclick="closeM('mReport')">âœ•</button>
    </div>
  </div>

  <div id="printable">
    <div class="card" style="border:2px solid #111">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div style="display:flex;align-items:center;gap:12px">
          <img id="labLogo" style="max-height:80px;max-width:260px;display:none"/>
          <div>
            <div id="labName" style="font-weight:700;font-size:18px">Laboratoire ContrÃ´le QualitÃ©</div>
            <div id="labMeta" class="muted"></div>
            <div id="labAuth" class="muted"></div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="muted" data-i="ref">RÃ©f. rapport</div><div id="repRef" style="font-weight:600"></div>
          <div class="muted" data-i="intcode">Code interne</div><div id="repIntRef" style="font-weight:600"></div>
          <div id="repDate" class="muted"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:600;margin-bottom:6px" data-i="ident">Identification de l'Ã©chantillon</div>
      <div class="grid g3" id="repIdent"></div>
    </div>

    <div class="card" id="repResults"></div>
    <div class="card" id="repLawRef" style="display:none"></div>
    <div class="card" id="repConclusion"></div>
    <div class="card" id="repNotes" style="display:none"></div>

    <div class="card">
      <div style="font-weight:600;margin-bottom:6px" data-i="validation">Validation</div>
      <div class="grid g2">
        <div><table><tbody>
          <tr><td data-i="validatedby">ValidÃ© par</td><td id="vBy">â€”</td></tr>
          <tr><td data-i="role">Fonction</td><td id="vRole">â€”</td></tr>
          <tr><td data-i="date">Date</td><td id="vDate">â€”</td></tr>
          <tr><td>Commentaire</td><td id="vComment">â€”</td></tr>
        </tbody></table></div>
        <div style="border:1px dashed #aaa;border-radius:10px;height:90px;display:flex;align-items:center;justify-content:center" class="muted" data-i="stamp">Cachet & signature</div>
      </div>
      <div class="muted" style="margin-top:6px" data-i="iso">Rapport conforme ISO/CEI 17025. Reproduction interdite sauf accord Ã©crit.</div>
    </div>
  </div>
</div></div>

<!-- IDENTITÃ‰ -->
<div class="modal-bg" id="mSettings"><div class="modal">
  <div class="row"><div style="font-weight:600" data-i="labid">IdentitÃ© du laboratoire</div><button class="btn no-print" onclick="closeM('mSettings')">âœ•</button></div>
  <div class="grid g2">
    <div><div class="muted" data-i="labname">Nom</div><input class="input" id="st_name" value="Laboratoire ContrÃ´le QualitÃ©"/></div>
    <div><div class="muted" data-i="authnum">NÂ° autorisation ministÃ©rielle</div><input class="input" id="st_auth"/></div>
    <div><div class="muted" data-i="address">Adresse</div><input class="input" id="st_addr"/></div>
    <div><div class="muted" data-i="phone">TÃ©lÃ©phone</div><input class="input" id="st_phone"/></div>
    <div style="grid-column:1/span 2"><div class="muted">Email</div><input class="input" id="st_email"/></div>
  </div>
  <div class="muted" style="margin-top:6px" data-i="logo">Logo (PNG/JPG/SVG)</div><input type="file" id="st_logo" accept="image/*"/>
  <div class="logoBox" style="margin-top:6px"><img id="st_logoPrev" style="max-height:80px;max-width:260px;display:none"/></div>
  <div class="row no-print" style="justify-content:flex-end"><button class="btn" onclick="saveSettings()" data-i="save">Enregistrer</button></div>
</div></div>

<!-- CLIENTS -->
<div class="modal-bg" id="mClients"><div class="modal">
  <div class="row"><div style="font-weight:600" data-i="clients">Clients</div><button class="btn no-print" onclick="closeM('mClients')">âœ•</button></div>
  <div class="grid g3">
    <div><div class="muted" data-i="name">Nom *</div><input class="input" id="cl_name"/></div>
    <div><div class="muted" data-i="address">Adresse</div><input class="input" id="cl_addr"/></div>
    <div><div class="muted" data-i="phone">TÃ©lÃ©phone</div><input class="input" id="cl_phone"/></div>
    <div style="grid-column:1/span 3"><div class="muted">Email</div><input class="input" id="cl_email"/></div>
  </div>
  <div class="row no-print" style="justify-content:flex-end;gap:6px">
    <button class="btn" onclick="saveClient()" data-i="save">Enregistrer</button>
    <button class="btn" id="btnCancelClientEdit" style="display:none" onclick="cancelClientEdit()" data-i="canceledit">Annuler Ã©dition</button>
  </div>
  <div id="clientsList" style="margin-top:8px"></div>
</div></div>

<!-- CATALOGUE PRODUITS -->
<div class="modal-bg" id="mCatalog"><div class="modal">
  <div class="row"><div style="font-weight:600">Catalogue produits & paramÃ¨tres</div><button class="btn no-print" onclick="closeM('mCatalog')">âœ•</button></div>

  <div class="grid g2">
    <!-- Liste produits -->
    <div class="card">
      <div class="row"><div style="font-weight:600">Produits</div>
        <div><button class="btn" onclick="newProduct()">+ Produit</button></div>
      </div>
      <div id="prodList" class="tbl" style="max-height:260px;overflow:auto"></div>
      <div class="grid g2" style="margin-top:8px">
        <div><div class="muted">Nom produit *</div><input class="input" id="cat_p_name"/></div>
        <div><div class="muted">RÃ©f. lÃ©gislative</div><input class="input" id="cat_p_law"/></div>
      </div>
      <div class="row" style="justify-content:flex-end"><button class="btn" onclick="saveProduct()">Enregistrer produit</button></div>
    </div>

    <!-- Services & paramÃ¨tres -->
    <div class="card">
      <div class="row"><div style="font-weight:600">Services & paramÃ¨tres</div>
        <div style="display:flex;gap:6px">
          <select class="input" id="cat_service_sel" style="min-width:220px"></select>
          <button class="btn" onclick="addService()">+ Service</button>
          <button class="btn" onclick="delService()">Supprimer service</button>
        </div>
      </div>
      <div class="tbl" style="max-height:240px;overflow:auto">
        <table id="cat_params_tbl">
          <thead><tr><th>ParamÃ¨tre</th><th>UnitÃ©</th><th>MÃ©thode/Norme</th><th>Limite</th><th>ðŸ”’</th><th></th></tr></thead>
          <tbody id="cat_params_body"></tbody>
        </table>
      </div>
      <div class="row" style="justify-content:flex-end;gap:6px">
        <button class="btn" onclick="addCatalogParam()">+ ParamÃ¨tre</button>
        <button class="btn btn-primary" onclick="saveCatalog()">Enregistrer paramÃ¨tres</button>
      </div>
    </div>
  </div>
</div></div>

<!-- VALIDATEUR -->
<div class="modal-bg" id="mValidator"><div class="modal">
  <div class="row"><div style="font-weight:600">DonnÃ©es du validateur</div><button class="btn no-print" onclick="closeM('mValidator')">âœ•</button></div>
  <div class="grid g3">
    <div><div class="muted">Nom & prÃ©nom *</div><input class="input" id="val_name"/></div>
    <div><div class="muted">Fonction *</div><input class="input" id="val_role"/></div>
    <div><div class="muted">Date *</div><input type="date" class="input" id="val_date"/></div>
    <div style="grid-column:1/span 3"><div class="muted">Commentaire</div><textarea class="input" id="val_comment" rows="2" placeholder="Observations de validation"></textarea></div>
  </div>
  <div class="row" style="justify-content:flex-end"><button class="btn btn-primary" onclick="saveValidator()">Enregistrer</button></div>
</div></div>

<!-- RESTORE -->
<div class="modal-bg" id="mRestore"><div class="modal">
  <div class="row"><div style="font-weight:600" data-i="restore">Restaurer</div><button class="btn no-print" onclick="closeM('mRestore')">âœ•</button></div>
  <div class="grid g2">
    <div style="grid-column:1/span 2"><input type="file" id="restoreFile" accept=".json,.qclab,.qclab.json"/></div>
    <div><div class="muted" data-i="mode">Mode</div><select class="input" id="restoreMode"><option value="replace" data-i="replace">Remplacer</option><option value="merge" data-i="merge">Fusionner</option></select></div>
    <div id="restoreMsg" class="muted"></div>
  </div>
  <div class="row no-print" style="justify-content:flex-end"><button class="btn" onclick="doRestore()" data-i="restorebtn">Restaurer</button></div>
</div></div>

<footer class="muted" style="text-align:center;padding:10px">QC Lab Lite v3.2</footer>

<script>
/* ===================== i18n ===================== */
let LANG = localStorage.getItem('qcl_lang') || 'fr';
const TR = {
  fr: {'stats.samples':'Ã‰chantillons','stats.soon':'Ã‰chÃ©ance â‰¤48h','stats.year':'AnnÃ©e courante',
    search:'Recherche',service:'Service',priority:'PrioritÃ©',all:'Tous',allf:'Toutes',
    code:'Code',intcode:'Code interne',client:'Client',prodsvc:'Produit/Service',sampler:'PrÃ©leveur',
    recv:'RÃ©ception',due:'Ã‰chÃ©ance',prio:'PrioritÃ©',actions:'Actions',
    newsample:'Nouvel Ã©chantillon',new:'Nouveau',clientaddr:'Adresse client',
    product:'Produit',brand:'Nom commercial',qty:'Poids / QtÃ©',temp:'TempÃ©rature (Â°C)',
    loc:'Lieu prÃ©lÃ¨vement',labtech:'Technicien labo',notes:'Notes',
    mfg:'Fabrication',exp:'Expiration',
    tests:'Tests',addtest:'+ Test',cancel:'Annuler',save:'Enregistrer',
    report:'Rapport',printpdf:'Imprimer / PDF',exportword:'Exporter Word',validate:'Valider rapport',unvalidate:'Annuler validation',
    ref:'RÃ©f. rapport',ident:"Identification de l'Ã©chantillon",validation:'Validation',
    validatedby:'ValidÃ© par',role:'Fonction',date:'Date',stamp:'Cachet & signature',
    iso:'Rapport conforme ISO/CEI 17025. Reproduction interdite sauf accord Ã©crit.',
    labid:'IdentitÃ© du laboratoire',labname:'Nom',authnum:'NÂ° autorisation ministÃ©rielle',address:'Adresse',phone:'TÃ©lÃ©phone',logo:'Logo (PNG/JPG/SVG)',
    clients:'Clients',canceledit:'Annuler Ã©dition',products:'Produits & services',param:'ParamÃ¨tre',unit:'UnitÃ©',method:'MÃ©thode/Norme',
    limit:'Limite / RÃ©fÃ©rence',lock:'Verrouiller norme',law:'RÃ©f. lÃ©gislative (produit)',addsvc:'Ajouter service',addparam:'Ajouter paramÃ¨tre',locknote:'Les normes verrouillÃ©es seront en lecture seule dans les rapports.',
    restore:'Restaurer',mode:'Mode',replace:'Remplacer',merge:'Fusionner',restorebtn:'Restaurer',lawref:'RÃ©fÃ©rence lÃ©gislative'
  },
  ar: {'stats.samples':'Ø§Ù„Ø¹ÙŠÙ†Ø§Øª','stats.soon':'Ø§Ù„Ø¢Ø¬Ø§Ù„ â‰¤ Ù¤Ù¨ Ø³Ø§Ø¹Ø©','stats.year':'Ø³Ù†Ø© Ø¬Ø§Ø±ÙŠØ©',
    search:'Ø¨Ø­Ø«',service:'Ø§Ù„Ø®Ø¯Ù…Ø©',priority:'Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©',all:'Ø§Ù„ÙƒÙ„',allf:'Ø§Ù„ÙƒÙ„',
    code:'Ø§Ù„Ù…Ø±Ø¬Ø¹',intcode:'Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ',client:'Ø§Ù„Ø²Ø¨ÙˆÙ†',prodsvc:'Ø§Ù„Ù…Ù†ØªØ¬/Ø§Ù„Ø®Ø¯Ù…Ø©',sampler:'Ø§Ù„Ø¢Ø®Ø°',recv:'Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„',due:'Ø§Ù„Ø£Ø¬Ù„',p
