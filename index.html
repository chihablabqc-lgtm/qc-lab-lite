<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>QC Lab Lite v2.2 (fix) — OFFLINE</title>
<style>
:root{--bg:#f7f7f7;--mut:#666;--bd:#ddd;--ink:#111}
*{box-sizing:border-box} body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);z-index:10}
.container{max-width:1120px;margin:0 auto;padding:10px}
.btn{padding:8px 12px;border:1px solid #ccc;border-radius:10px;background:#fff;cursor:pointer}
.btn-primary{background:#111;color:#fff;border:none} .btn-danger{background:#c62828;color:#fff;border:none}
.card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px}
.grid{display:grid;gap:10px} .g3{grid-template-columns:repeat(3,1fr)} .g2{grid-template-columns:repeat(2,1fr)}
.input,select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:10px}
table{width:100%;border-collapse:collapse} th,td{padding:8px;border-top:1px solid #eee;text-align:left;font-size:14px}
.muted{color:var(--mut);font-size:12px}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#fff;border-radius:14px;border:1px solid var(--bd);max-width:1080px;width:95vw;max-height:90vh;overflow:auto;padding:12px}
.logoBox{border:1px solid var(--bd);border-radius:10px;min-height:70px;min-width:220px;display:flex;align-items:center;justify-content:center}
.chip{border:1px solid #ddd;border-radius:999px;padding:2px 8px;font-size:12px}
.ok{background:#eaffea} .nc{background:#ffecec}
.reportHeader{border:1px solid #111;border-radius:8px;padding:10px;margin-bottom:8px;background:#fff}
.section{border:1px solid #111;border-radius:8px;padding:10px;margin-top:8px;background:#fff}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin:6px 0}
@media print{header,.no-print{display:none!important} body{background:#fff} .card{border:none;padding:0}}
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
    <div style="display:flex;align-items:center;gap:8px">
      <img id="labLogoSmall" style="max-height:40px;max-width:180px;display:none"/>
      <div>
        <div id="labNameHdr" style="font-weight:700">QC Lab Lite</div>
        <div id="labMetaHdr" class="muted"></div>
      </div>
    </div>
    <div class="no-print" style="display:flex;gap:6px;flex-wrap:wrap">
      <button class="btn" id="btnClients">Clients</button>
      <button class="btn" id="btnProd">Produits & services</button>
      <button class="btn" id="btnSettings">Identité labo</button>
      <button class="btn" id="btnExport">Exporter CSV</button>
      <button class="btn" id="btnBackup">Sauvegarder</button>
      <button class="btn" id="btnRestore">Restaurer</button>
      <button class="btn btn-primary" id="btnNew">+ Nouvel échantillon</button>
    </div>
  </div>
</header>

<main class="container grid" style="gap:12px">
  <div class="grid g3">
    <div class="card"><div class="muted">Échantillons</div><div id="statTotal" style="font-weight:700">0</div></div>
    <div class="card"><div class="muted">Échéance ≤48h</div><div id="statSoon" style="font-weight:700">0</div></div>
    <div class="card"><div class="muted">Année courante</div><div id="statYear" style="font-weight:700">0</div></div>
  </div>

  <div class="grid g3">
    <div><div class="muted">Recherche</div><input class="input" id="q" placeholder="Code, client, produit, service, facture"/></div>
    <div><div class="muted">Service</div><select class="input" id="fService"><option>Tous</option><option>Physico-chimie</option><option>Microbiologie</option></select></div>
    <div><div class="muted">Priorité</div><select class="input" id="fPriority"><option>Toutes</option><option>Normale</option><option>Urgente</option><option>Critique</option></select></div>
  </div>

  <div class="card" style="padding:0;overflow:auto">
    <table>
      <thead><tr><th>Code</th><th>Client</th><th>Produit/Service</th><th>N° facture</th><th>Préleveur</th><th>Réception</th><th>Échéance</th><th>Priorité</th><th class="no-print" style="text-align:right">Actions</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</main>

<!-- Sample modal -->
<div class="modal-bg" id="mSample"><div class="modal">
  <div class="row"><div style="font-weight:600" id="mSampleTitle">Nouvel échantillon</div><button class="btn no-print" onclick="closeM('mSample')">✕</button></div>
  <form id="sampleForm">
    <div class="grid g3">
      <div><div class="muted">Code</div><input class="input" id="s_code"/></div>
      <div><div class="muted">Client</div><div style="display:flex;gap:6px"><select class="input" id="s_client"></select><button type="button" class="btn" onclick="openM('mClients')">Nouveau</button></div></div>
      <div><div class="muted">Adresse client</div><input class="input" id="s_clientAddr"/></div>

      <div><div class="muted">Produit</div><select class="input" id="s_product"></select></div>
      <div><div class="muted">Service</div><select class="input" id="s_service"><option value="">—</option><option>Physico-chimie</option><option>Microbiologie</option></select></div>
      <div style="display:flex;align-items:flex-end"><button type="button" class="btn" onclick="loadParams()">Charger paramètres</button></div>

      <div><div class="muted">Nom commercial</div><input class="input" id="s_brand"/></div>
      <div><div class="muted">Poids / Qté</div><input class="input" id="s_qty"/></div>
      <div><div class="muted">Température (°C)</div><input class="input" id="s_temp"/></div>

      <div><div class="muted">Lieu prélèvement</div><input class="input" id="s_loc"/></div>
      <div><div class="muted">N° facture</div><input class="input" id="s_invoice"/></div>
      <div><div class="muted">Préleveur</div><select class="input" id="s_sampler"><option>Client</option><option>Technicien labo</option></select></div>
      <div><div class="muted">Réception</div><input type="date" class="input" id="s_recv"/></div>
      <div><div class="muted">Échéance</div><input type="date" class="input" id="s_due"/></div>
      <div><div class="muted">Priorité</div><select class="input" id="s_priority"><option>Normale</option><option>Urgente</option><option>Critique</option></select></div>

      <div style="grid-column:1/span 3"><div class="muted">Notes</div><textarea class="input" rows="2" id="s_notes"></textarea></div>
    </div>

    <div class="row" style="margin-top:8px"><div style="font-weight:600">Tests</div><div class="no-print" style="display:flex;gap:6px"><button type="button" class="btn" onclick="addTest()">+ Test</button></div></div>
    <div id="testsZone" class="grid" style="margin-top:6px"></div>

    <div class="row no-print" style="justify-content:flex-end;margin-top:10px">
      <button type="button" class="btn" onclick="closeM('mSample')">Annuler</button>
      <button class="btn btn-primary" type="submit">Enregistrer</button>
    </div>
  </form>
</div></div>

<!-- Report modal -->
<div class="modal-bg" id="mReport"><div class="modal">
  <div class="row"><div style="font-weight:600">Rapport</div>
    <div class="no-print" style="display:flex;gap:6px">
      <button class="btn" onclick="window.print()">Imprimer / PDF</button>
      <button class="btn" onclick="exportWord()">Exporter Word</button>
      <button class="btn btn-primary" id="btnValidate" onclick="validateReport()">Valider rapport</button>
      <button class="btn btn-danger" id="btnUnvalidate" onclick="unvalidateReport()" style="display:none">Annuler validation</button>
      <button class="btn" onclick="closeM('mReport')">✕</button>
    </div>
  </div>

  <div id="printable">
    <div class="reportHeader">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div style="display:flex;align-items:center;gap:12px">
          <img id="labLogo" style="max-height:80px;max-width:260px;display:none"/>
          <div>
            <div id="labName" style="font-weight:700;font-size:18px">Laboratoire Contrôle Qualité</div>
            <div id="labMeta" class="muted"></div>
            <div id="labAuth" class="muted"></div>
          </div>
        </div>
        <div style="text-align:right"><div class="muted">Réf. rapport</div><div id="repRef" style="font-weight:600"></div><div id="repDate" class="muted"></div></div>
      </div>
    </div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Identification de l'échantillon</div>
      <div class="grid g3" id="repIdent"></div>
    </div>

    <div class="section" id="repResults"></div>
    <div class="section" id="repConclusion"></div>
    <div class="section" id="repNotes" style="display:none"></div>

    <div class="section">
      <div style="font-weight:600;margin-bottom:6px">Validation</div>
      <div class="grid g2">
        <div><table><tbody>
          <tr><td>Validé par</td><td id="vBy">—</td></tr>
          <tr><td>Fonction</td><td id="vRole">—</td></tr>
          <tr><td>Date</td><td id="vDate">—</td></tr>
        </tbody></table></div>
        <div style="border:1px dashed #aaa;border-radius:10px;height:90px;display:flex;align-items:center;justify-content:center" class="muted">Cachet & signature</div>
      </div>
      <div class="muted" style="margin-top:6px">Rapport conforme ISO/CEI 17025. Reproduction interdite sauf accord écrit.</div>
    </div>
  </div>
</div></div>

<!-- Settings modal -->
<div class="modal-bg" id="mSettings"><div class="modal">
  <div class="row"><div style="font-weight:600">Identité du laboratoire</div><button class="btn no-print" onclick="closeM('mSettings')">✕</button></div>
  <div class="grid g2">
    <div><div class="muted">Nom</div><input class="input" id="st_name" value="Laboratoire Contrôle Qualité"/></div>
    <div><div class="muted">N° autorisation ministérielle</div><input class="input" id="st_auth"/></div>
    <div><div class="muted">Adresse</div><input class="input" id="st_addr"/></div>
    <div><div class="muted">Téléphone</div><input class="input" id="st_phone"/></div>
    <div style="grid-column:1/span 2"><div class="muted">Email</div><input class="input" id="st_email"/></div>
  </div>
  <div class="muted" style="margin-top:6px">Logo (PNG/JPG/SVG)</div><input type="file" id="st_logo" accept="image/*"/>
  <div class="logoBox" style="margin-top:6px"><img id="st_logoPrev" style="max-height:80px;max-width:260px;display:none"/></div>
  <div class="row no-print" style="justify-content:flex-end"><button class="btn" onclick="saveSettings()">Enregistrer</button></div>
</div></div>

<!-- Clients modal -->
<div class="modal-bg" id="mClients"><div class="modal">
  <div class="row"><div style="font-weight:600">Clients</div><button class="btn no-print" onclick="closeM('mClients')">✕</button></div>
  <div class="grid g3">
    <div><div class="muted">Nom *</div><input class="input" id="cl_name"/></div>
    <div><div class="muted">Adresse</div><input class="input" id="cl_addr"/></div>
    <div><div class="muted">Téléphone</div><input class="input" id="cl_phone"/></div>
    <div style="grid-column:1/span 3"><div class="muted">Email</div><input class="input" id="cl_email"/></div>
  </div>
  <div class="row no-print" style="justify-content:flex-end;gap:6px">
    <button class="btn" onclick="saveClient()">Enregistrer</button>
    <button class="btn" id="btnCancelClientEdit" style="display:none" onclick="cancelClientEdit()">Annuler édition</button>
  </div>
  <div id="clientsList" style="margin-top:8px"></div>
</div></div>

<!-- Produits & services modal -->
<div class="modal-bg" id="mProd"><div class="modal">
  <div class="row"><div style="font-weight:600">Produits & services</div><button class="btn no-print" onclick="closeM('mProd')">✕</button></div>
  <div class="grid g3">
    <div><div class="muted">Produit *</div><input class="input" id="pr_name" placeholder="ex. Lait"/></div>
    <div><div class="muted">Service</div><select class="input" id="pr_service"><option>Physico-chimie</option><option>Microbiologie</option></select></div>
    <div style="display:flex;align-items:flex-end"><button class="btn" onclick="addService()">Ajouter service</button></div>
    <div><div class="muted">Paramètre *</div><input class="input" id="pr_param"/></div>
    <div><div class="muted">Unité</div><input class="input" id="pr_unit"/></div>
    <div><div class="muted">Méthode/Norme</div><input class="input" id="pr_method"/></div>
    <div><div class="muted">Limite / Référence</div><input class="input" id="pr_ref" placeholder="ex. 6.6–6.8, ≤ 0.8"/></div>
    <div><div class="muted">Verrouiller norme</div><select class="input" id="pr_locked"><option value="1" selected>Oui</option><option value="0">Non</option></select></div>
    <div style="display:flex;align-items:flex-end"><button class="btn" onclick="addParam()">Ajouter paramètre</button></div>
  </div>
  <div class="muted" style="margin-top:6px">Les normes verrouillées seront en lecture seule dans les rapports.</div>
  <div id="prodList" style="margin-top:8px"></div>
</div></div>

<!-- Restore modal -->
<div class="modal-bg" id="mRestore"><div class="modal">
  <div class="row"><div style="font-weight:600">Restaurer</div><button class="btn no-print" onclick="closeM('mRestore')">✕</button></div>
  <div class="grid g2">
    <div style="grid-column:1/span 2"><input type="file" id="restoreFile" accept=".json,.qclab,.qclab.json"/></div>
    <div><div class="muted">Mode</div><select class="input" id="restoreMode"><option value="replace">Remplacer</option><option value="merge">Fusionner</option></select></div>
    <div id="restoreMsg" class="muted"></div>
  </div>
  <div class="row no-print" style="justify-content:flex-end"><button class="btn" onclick="doRestore()">Restaurer</button></div>
</div></div>

<footer class="muted" style="text-align:center;padding:10px">OFFLINE v2.2 (fix) — 2025-08-17T17:26:13.618418Z</footer>

<script>
// Keys
const K_S="qcv22f_samples", K_T="qcv22f_settings", K_C="qcv22f_clients", K_P="qcv22f_products";
// Utils
const uid=()=>Math.random().toString(36).slice(2,10);
const tISO=()=>new Date().toISOString().slice(0,10);
const fmt=d=>{if(!d)return"";const x=new Date(d);return String(x.getDate()).padStart(2,'0')+"/"+String(x.getMonth()+1).padStart(2,'0')+"/"+x.getFullYear();};
const get=(k,d)=>{try{return JSON.parse(localStorage.getItem(k)||"null")||d}catch(e){return d}};
const set=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const esc=s=>String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

// Data
let samples=get(K_S,[]),
    settings=get(K_T,{name:"Laboratoire Contrôle Qualité",addr:"",phone:"",email:"",auth:"",logo:null}),
    clients=get(K_C,[]),
    products=get(K_P,[]);

// Presets (lockés)
const PRESET=[
  {name:"Lait reconstitué",services:[
    {name:"Physico-chimie",params:[
      {name:"pH",unit:"",ref:"6.6–6.8",method:"ISO 2917",locked:true},
      {name:"MG (Gerber)",unit:"%",ref:"≥ 3.5",method:"ISO 2446",locked:true},
      {name:"Densité",unit:"g/cm³",ref:"1.028–1.034",method:"Densimètre",locked:true}]}
  ]},
  {name:"Huile d'olive",services:[
    {name:"Physico-chimie",params:[
      {name:"Acidité libre",unit:"%",ref:"≤ 0.8",method:"Codex STAN 33",locked:true},
      {name:"Indice de peroxyde",unit:"meq O2/kg",ref:"≤ 20",method:"Codex STAN 33",locked:true}]}
  ]},
  {name:"Eau potable",services:[
    {name:"Physico-chimie",params:[
      {name:"pH",unit:"",ref:"6.5–8.5",method:"Métrologie pH",locked:true},
      {name:"Turbidité",unit:"NTU",ref:"≤ 1",method:"Turbidimètre",locked:true}]}
  ]}
];
if(products.length===0){
  products=PRESET.map(p=>({id:uid(),name:p.name,services:p.services.map(s=>({id:uid(),name:s.name,params:s.params.map(t=>({id:uid(),name:t.name,unit:t.unit,ref:t.ref,method:t.method,locked:true}))}))}));
  set(K_P,products);
}

// Header
function refreshHeader(){
  document.getElementById('labNameHdr').textContent=settings.name||"QC Lab Lite";
  document.getElementById('labMetaHdr').textContent=[settings.addr,settings.phone,settings.email].filter(Boolean).join(' • ');
  const lg=document.getElementById('labLogoSmall'); lg.src=settings.logo||""; lg.style.display=settings.logo?'block':'none';
} refreshHeader();

// Filters
const rowsEl=document.getElementById('rows'); const qEl=document.getElementById('q'); const fS=document.getElementById('fService'); const fP=document.getElementById('fPriority');
function filtered(){
  const q=(qEl.value||"").toLowerCase(); const s=fS.value; const p=fP.value;
  return samples.filter(x=>{
    const hay=[x.sampleCode,x.clientName,x.productType,x.serviceName,x.invoiceNumber].map(v=>(v||"").toLowerCase());
    const mq=!q || hay.some(v=>v.includes(q));
    const ms=s==="Tous" || x.serviceName===s;
    const mp=p==="Toutes" || x.priority===p;
    return mq&&ms&&mp;
  });
}
function render(){
  const list=filtered(); rowsEl.innerHTML="";
  if(list.length===0){ rowsEl.innerHTML='<tr><td colspan="9" style="text-align:center;color:#666;padding:20px">Aucun échantillon</td></tr>'; }
  else{
    list.forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML=[
        `<td>${esc(x.sampleCode||"")}</td>`,
        `<td>${esc(x.clientName||"")}</td>`,
        `<td>${esc(x.productType||"")}${x.serviceName?(" • "+esc(x.serviceName)):""}</td>`,
        `<td>${esc(x.invoiceNumber||"")}</td>`,
        `<td>${esc(x.samplerType||"")}</td>`,
        `<td>${fmt(x.receivedDate)}</td>`,
        `<td>${fmt(x.dueDate)}</td>`,
        `<td><span class="chip">${esc(x.priority||"")}</span></td>`,
        `<td class="no-print" style="text-align:right">
            <button class="btn" onclick="openReport('${x.id}')">Rapport</button>
            <button class="btn" onclick="editSample('${x.id}')">Éditer</button>
            <button class="btn" onclick="delSample('${x.id}')">Supprimer</button>
         </td>`
      ].join("");
      rowsEl.appendChild(tr);
    });
  }
  document.getElementById('statTotal').textContent=samples.length;
  document.getElementById('statSoon').textContent=samples.filter(x=>x.dueDate&&new Date(x.dueDate)<=new Date(Date.now()+2*24*3600*1000)).length;
  const y=new Date().getFullYear(); document.getElementById('statYear').textContent=samples.filter(x=>x.receivedDate&&new Date(x.receivedDate).getFullYear()===y).length;
}
qEl.oninput=fS.onchange=fP.onchange=render; render();

// Modals
function openM(id){ document.getElementById(id).style.display='flex'; }
function closeM(id){ document.getElementById(id).style.display='none'; }
['mSample','mReport','mSettings','mClients','mProd','mRestore'].forEach(id=>{
  document.getElementById(id).addEventListener('click',e=>{ if(e.target.id===id) closeM(id); });
});

// Buttons
document.getElementById('btnNew').onclick=()=>{editingId=null; openSample(true);};
document.getElementById('btnSettings').onclick=()=>openM('mSettings');
document.getElementById('btnClients').onclick=()=>{renderClients(); openM('mClients');};
document.getElementById('btnProd').onclick=()=>{renderProd(); openM('mProd');};
document.getElementById('btnRestore').onclick=()=>openM('mRestore');

// Selects
function populateClients(selected){
  const s=document.getElementById('s_client');
  s.innerHTML='<option value="">—</option>'+clients.map(c=>`<option value="${c.id}" ${selected===c.id?'selected':''}>${esc(c.name)}</option>`).join('');
}
function populateProducts(selected){
  const s=document.getElementById('s_product');
  s.innerHTML='<option value="">—</option>'+products.map(p=>`<option value="${p.id}" ${selected===p.id?'selected':''}>${esc(p.name)}</option>`).join('');
}
document.getElementById('s_client')?.addEventListener('change',()=>{
  const id=document.getElementById('s_client').value; const c=clients.find(x=>x.id===id);
  document.getElementById('s_clientAddr').value=c?c.addr||'':"";
});

// Clients (CRUD avec édition)
let editingClientId=null;
function renderClients(){
  const list=document.getElementById('clientsList');
  if(!clients.length){ list.innerHTML='<div class="muted">Aucun client</div>'; return; }
  list.innerHTML=clients.map(c=>`
    <div class='row'>
      <div><b>${esc(c.name)}</b> <span class='muted'>• ${esc(c.addr||"")} ${c.phone?("• "+esc(c.phone)):""} ${c.email?("• "+esc(c.email)):""}</span></div>
      <div>
        <button class='btn' onclick='editClient("${c.id}")'>Éditer</button>
        <button class='btn' onclick='delClient("${c.id}")'>Supprimer</button>
      </div>
    </div>`).join('');
}
function saveClient(){
  const name=document.getElementById('cl_name').value.trim();
  if(!name){alert('Nom client obligatoire');return;}
  const v={name,addr:document.getElementById('cl_addr').value.trim(),phone:document.getElementById('cl_phone').value.trim(),email:document.getElementById('cl_email').value.trim()};
  if(editingClientId){
    clients=clients.map(x=>x.id===editingClientId?{...x,...v}:x);
    editingClientId=null; document.getElementById('btnCancelClientEdit').style.display='none';
  }else{
    clients=[...clients,{id:uid(),...v}];
  }
  set(K_C,clients); renderClients(); populateClients("");
  document.getElementById('cl_name').value=document.getElementById('cl_addr').value=document.getElementById('cl_phone').value=document.getElementById('cl_email').value="";
}
function editClient(id){
  const c=clients.find(x=>x.id===id); if(!c) return;
  editingClientId=id;
  document.getElementById('cl_name').value=c.name||"";
  document.getElementById('cl_addr').value=c.addr||"";
  document.getElementById('cl_phone').value=c.phone||"";
  document.getElementById('cl_email').value=c.email||"";
  document.getElementById('btnCancelClientEdit').style.display='inline-block';
}
function cancelClientEdit(){
  editingClientId=null; document.getElementById('btnCancelClientEdit').style.display='none';
  document.getElementById('cl_name').value=document.getElementById('cl_addr').value=document.getElementById('cl_phone').value=document.getElementById('cl_email').value="";
}
function delClient(id){ if(!confirm('Supprimer ?')) return; clients=clients.filter(x=>x.id!==id); set(K_C,clients); renderClients(); populateClients(""); }

// Produits & services
function renderProd(){
  const box=document.getElementById('prodList');
  if(!products.length){ box.innerHTML='<div class="muted">Aucun produit</div>'; return; }
  box.innerHTML=(products||[]).map(p=>`<div class='row'><div><b>${esc(p.name)}</b> <span class='muted'>(${(p.services||[]).length} service)</span></div></div>`+(p.services||[]).map(s=>`<div class='row' style='padding-left:28px'><div><b>${esc(s.name)}</b> <span class='muted'>• ${s.params.length} paramètre(s)</span></div></div>`+(s.params||[]).map(t=>`<div class='row' style='padding-left:56px'><div>${esc(t.name)} <span class='muted'>• ${esc(t.unit||"")} • ${esc(t.method||"")} • ${esc(t.ref||"")} ${t.locked?'<span style="border:1px solid #aaa;border-radius:999px;padding:0 6px">verrouillé</span>':''}</span></div></div>`).join('')).join('');
}
function addService(){
  const pn=document.getElementById('pr_name').value.trim(); if(!pn){alert('Produit obligatoire');return;}
  const sn=document.getElementById('pr_service').value;
  let p=products.find(x=>x.name.toLowerCase()===pn.toLowerCase());
  if(!p){p={id:uid(),name:pn,services:[]}; products.push(p);}
  let sv=(p.services||[]).find(x=>x.name===sn);
  if(!sv){sv={id:uid(),name:sn,params:[]}; p.services.push(sv);}
  set(K_P,products); renderProd();
}
function addParam(){
  const pn=document.getElementById('pr_name').value.trim();
  const sn=document.getElementById('pr_service').value;
  const t=document.getElementById('pr_param').value.trim();
  if(!pn||!t){alert('Produit et paramètre obligatoires');return;}
  const unit=document.getElementById('pr_unit').value.trim();
  const method=document.getElementById('pr_method').value.trim();
  const ref=document.getElementById('pr_ref').value.trim();
  const locked=document.getElementById('pr_locked').value==='1';
  let p=products.find(x=>x.name.toLowerCase()===pn.toLowerCase());
  if(!p){p={id:uid(),name:pn,services:[]}; products.push(p);}
  let sv=(p.services||[]).find(x=>x.name===sn);
  if(!sv){sv={id:uid(),name:sn,params:[]}; p.services.push(sv);}
  sv.params.push({id:uid(),name:t,unit,method,ref,locked});
  set(K_P,products); renderProd();
}

// Sample form
let editingId=null;
function openSample(newItem){
  openM('mSample');
  const s=newItem?{
    sampleCode:"",clientId:"",clientName:"",clientAddress:"",productId:"",productType:"",serviceName:"",
    brandName:"",quantity:"",temperature:"",samplingLocation:"",invoiceNumber:"",samplerType:"Client",
    receivedDate:tISO(),dueDate:"",priority:"Normale",notes:"",tests:[],validated:false,conclusionManual:null,
    validatorName:"",validatorRole:"",validatorDate:""
  } : samples.find(x=>x.id===editingId);
  document.getElementById('mSampleTitle').textContent=editingId?"Modifier l'échantillon":"Nouvel échantillon";
  document.getElementById('s_code').value=s.sampleCode||"";
  populateClients(s.clientId); document.getElementById('s_clientAddr').value=s.clientAddress||"";
  populateProducts(s.productId); document.getElementById('s_service').value=s.serviceName||"";
  document.getElementById('s_brand').value=s.brandName||""; document.getElementById('s_qty').value=s.quantity||""; document.getElementById('s_temp').value=s.temperature||"";
  document.getElementById('s_loc').value=s.samplingLocation||""; document.getElementById('s_invoice').value=s.invoiceNumber||""; document.getElementById('s_sampler').value=s.samplerType||"Client";
  document.getElementById('s_recv').value=s.receivedDate||tISO(); document.getElementById('s_due').value=s.dueDate||""; document.getElementById('s_priority').value=s.priority||"Normale";
  document.getElementById('s_notes').value=s.notes||"";
  const zone=document.getElementById('testsZone'); zone.innerHTML="";
  (s.tests||[]).forEach(addTestRow);
}
function editSample(id){ editingId=id; openSample(false); }
function delSample(id){ if(!confirm('Supprimer ?')) return; samples=samples.filter(x=>x.id!==id); set(K_S,samples); render(); }
document.getElementById('sampleForm').onsubmit=(e)=>{
  e.preventDefault();
  const cid=document.getElementById('s_client').value; const c=clients.find(x=>x.id===cid);
  const pid=document.getElementById('s_product').value; const p=products.find(x=>x.id===pid);
  const tests=[...document.querySelectorAll('#testsZone .card')].map(row=>{const obj={}; row.querySelectorAll('[data-k]').forEach(inp=>obj[inp.getAttribute('data-k')]=inp.value); obj.locked = row.getAttribute('data-locked')==='1'; return obj;});
  const v={ sampleCode:document.getElementById('s_code').value.trim(), clientId:cid, clientName:c?c.name:"", clientAddress:document.getElementById('s_clientAddr').value.trim(), productId:pid, productType:p?p.name:"", serviceName:document.getElementById('s_service').value, brandName:document.getElementById('s_brand').value.trim(), quantity:document.getElementById('s_qty').value.trim(), temperature:document.getElementById('s_temp').value.trim(), samplingLocation:document.getElementById('s_loc').value.trim(), invoiceNumber:document.getElementById('s_invoice').value.trim(), samplerType:document.getElementById('s_sampler').value, receivedDate:document.getElementById('s_recv').value, dueDate:document.getElementById('s_due').value, priority:document.getElementById('s_priority').value, notes:document.getElementById('s_notes').value, tests, validated:false, conclusionManual:null, validatorName:"", validatorRole:"", validatorDate:"" };
  if(editingId){ samples=samples.map(x=>x.id===editingId?{...x,...v}:x); } else { samples=[{id:uid(),...v},...samples]; }
  set(K_S,samples); render(); closeM('mSample');
};

// Test rows
function addTestRow(t){
  const zone=document.getElementById('testsZone');
  const div=document.createElement('div'); div.className='card'; div.style.display='grid'; div.style.gridTemplateColumns='repeat(6,1fr)'; div.style.gap='6px';
  div.setAttribute('data-locked', t.locked?'1':'0');
  div.innerHTML=[
    `<input class='input' placeholder='Paramètre' value='${esc(t.name||"")}' data-k='name' ${t.locked?'readonly':''}/>`,
    `<input class='input' placeholder='Unité' value='${esc(t.unit||"")}' data-k='unit' ${t.locked?'readonly':''}/>`,
    `<input class='input' placeholder='Méthode/Norme' value='${esc(t.method||"")}' data-k='method' ${t.locked?'readonly':''}/>`,
    `<input class='input' placeholder='Limite / Référence' value='${esc(t.ref||"")}' data-k='ref' ${t.locked?'readonly':''}/>`,
    `<input class='input' placeholder='Résultat' value='${esc(t.result||"")}' data-k='result'/>`,
    `<div style='text-align:right'><button type='button' class='btn' onclick='this.parentElement.parentElement.remove()'>Supprimer</button></div>`
  ].join("");
  zone.appendChild(div);
}
function addTest(){ addTestRow({name:"",unit:"",method:"",ref:"",result:"",locked:false}); }
function loadParams(){
  const prodId=document.getElementById('s_product').value; const service=document.getElementById('s_service').value;
  const p=products.find(x=>x.id===prodId); const sv=p?(p.services||[]).find(s=>s.name===service):null;
  if(!sv){alert('Choisir produit + service');return;}
  document.getElementById('testsZone').innerHTML="";
  (sv.params||[]).forEach(t=>addTestRow(t));
}

// Conformité
function toNum(s){ if(s==null) return null; const m=String(s).replace(',', '.').match(/-?\d+(?:\.\d+)?/); return m?parseFloat(m[0]):null; }
function isOk(result,ref){
  if(result==null||result==='') return null;
  if(!ref||!String(ref).trim()) return null;
  const r=toNum(result); if(r==null) return null;
  const R=String(ref).replace(',', '.').trim();
  let m=R.match(/(-?\d+(?:\.\d+)?)\s*[–-]\s*(-?\d+(?:\.\d+)?)/); if(m) return r>=parseFloat(m[1])&&r<=parseFloat(m[2]);
  m=R.match(/^(?:<=|≤)\s*(-?\d+(?:\.\d+)?)/); if(m) return r<=parseFloat(m[1]);
  m=R.match(/^(?:>=|≥)\s*(-?\d+(?:\.\d+)?)/); if(m) return r>=parseFloat(m[1]);
  m=R.match(/^<\s*(-?\d+(?:\.\d+)?)/); if(m) return r<parseFloat(m[1]);
  m=R.match(/^>\s*(-?\d+(?:\.\d+)?)/); if(m) return r>parseFloat(m[1]);
  m=R.match(/^(?:=)?\s*(-?\d+(?:\.\d+)?)/); if(m) return r===parseFloat(m[1]);
  return null;
}

// Report helpers
function numberFor(s){
  const y=s.receivedDate?new Date(s.receivedDate).getFullYear():new Date().getFullYear();
  const pref=s.serviceName==='Physico-chimie'?'PH':(s.serviceName==='Microbiologie'?'MC':'XX');
  const same=samples.filter(x=>x.serviceName===s.serviceName && x.receivedDate && new Date(x.receivedDate).getFullYear()===y).sort((a,b)=>new Date(a.receivedDate)-new Date(b.receivedDate));
  let i=1; for(const k of same){ if(k.id===s.id) break; i++; } return pref+'-'+String(i).padStart(3,'0')+'/'+y;
}

let currentReportId=null;
function openReport(id){
  currentReportId=id;
  const s=samples.find(x=>x.id===id); if(!s) return; openM('mReport');
  const lgs=document.getElementById('labLogo'); lgs.src=settings.logo||""; lgs.style.display=settings.logo?'block':'none';
  document.getElementById('labName').textContent=settings.name||"Laboratoire Contrôle Qualité";
  document.getElementById('labMeta').textContent=[settings.addr,settings.phone,settings.email].filter(Boolean).join(' • ');
  document.getElementById('labAuth').textContent=settings.auth?("Autorisation ministérielle : "+settings.auth):"";
  document.getElementById('repRef').textContent=numberFor(s);
  document.getElementById('repDate').textContent="Émis le "+fmt(new Date());

  const ident=document.getElementById('repIdent');
  ident.innerHTML=[
    `<div><div class='muted'>Client</div><div><b>${esc(s.clientName||"")}</b></div></div>`,
    `<div><div class='muted'>Produit / Service</div><div><b>${esc(s.productType||"")}${s.serviceName?" • "+esc(s.serviceName):""}</b></div></div>`,
    `<div><div class='muted'>Nom commercial</div><div>${esc(s.brandName||"—")}</div></div>`,
    `<div><div class='muted'>Poids / Qté</div><div>${esc(s.quantity||"—")}</div></div>`,
    `<div><div class='muted'>Température</div><div>${esc(s.temperature||"—")}</div></div>`,
    `<div><div class='muted'>Préleveur</div><div>${esc(s.samplerType||"—")}</div></div>`,
    `<div><div class='muted'>Lieu de prélèvement</div><div>${esc(s.samplingLocation||"—")}</div></div>`,
    `<div><div class='muted'>N° facture</div><div>${esc(s.invoiceNumber||"—")}</div></div>`,
    `<div><div class='muted'>Réception / Échéance</div><div>${fmt(s.receivedDate)} • ${fmt(s.dueDate)}</div></div>`
  ].join("");

  const res=document.getElementById('repResults');
  res.innerHTML='<div style="font-weight:600;margin-bottom:6px">Résultats</div><table style="width:100%"><thead><tr><th>Paramètre</th><th>Méthode/Norme</th><th>Résultat</th><th>Unité</th><th>Limite</th><th>Conformité</th></tr></thead><tbody id="rBody"></tbody></table>';
  const tb=document.getElementById('rBody'); let total=0,ok=0,nc=0,na=0;
  (s.tests||[]).forEach(t=>{
    const conf=isOk(t.result,t.ref);
    const txt=conf==null?'—':(conf?'Conforme':'Non conforme');
    const tr=document.createElement('tr'); if(conf===false) tr.className='nc';
    tr.innerHTML=[
      `<td>${esc(t.name||"")}</td>`,
      `<td>${esc(t.method||"")}</td>`,
      `<td>${esc(t.result||"")}</td>`,
      `<td>${esc(t.unit||"")}</td>`,
      `<td>${esc(t.ref||"")}</td>`,
      `<td>${esc(txt)}${conf===false?' ⚠︎':''}</td>`
    ].join("");
    tb.appendChild(tr);
    total++; if(conf===true) ok++; else if(conf===false) nc++; else na++;
  });

  const concl=document.getElementById('repConclusion');
  const isValidated=!!s.validated;
  let textAuto="Conformité non évaluée.";
  if(total>0 && (ok+nc)>0){ textAuto = (nc>0) ? "❌ Échantillon NON CONFORME aux exigences." : "✅ Échantillon CONFORME aux exigences."; }
  const textFinal = s.conclusionManual!=null ? s.conclusionManual : textAuto;
  const cls = (s.conclusionManual!=null ? (s.conclusionManual.includes("NON CONFORME")?'nc':'ok') : (nc>0?'nc':'ok'));
  concl.innerHTML = [
    "<div style='font-weight:600;margin-bottom:6px'>Conclusion</div>",
    "<div id='conclBox' class='card "+cls+"' style='padding:8px'>",
      "<div id='conclText'>"+esc(textFinal)+"</div>",
      "<div class='muted' style='margin-top:4px'>Règle auto : conforme si tous les paramètres évaluables sont dans leur tolérance.</div>",
      "<div class='no-print' style='margin-top:6px;"+(isValidated?'display:none':'')+"'>",
        "<button class='btn' onclick='editConclusion()'>Modifier la conclusion</button> ",
        "<button class='btn' onclick='resetConclusion()'>Revenir à l’auto</button>",
      "</div>",
    "</div>"
  ].join("");

  const notes=document.getElementById('repNotes');
  if(s.notes){notes.style.display='block'; notes.innerHTML="<div style='font-weight:600;margin-bottom:6px'>Observations</div><div>"+esc(s.notes)+"</div>";} else notes.style.display='none';

  document.getElementById('btnValidate').style.display = isValidated?'none':'inline-block';
  document.getElementById('btnUnvalidate').style.display = isValidated?'inline-block':'none';
}
function editConclusion(){
  const s=samples.find(x=>x.id===currentReportId); if(!s||s.validated) return;
  const box=document.getElementById('conclBox'); const txt=document.getElementById('conclText').textContent;
  box.innerHTML = "<textarea id='conclEdit' class='input' rows='3'>"+esc(txt)+"</textarea><div class='no-print' style='text-align:right;margin-top:6px'><button class='btn' onclick='saveConclusion()'>Enregistrer</button></div>";
}
function saveConclusion(){ const s=samples.find(x=>x.id===currentReportId); if(!s) return; const v=document.getElementById('conclEdit').value.trim(); s.conclusionManual = v||null; set(K_S,samples); openReport(currentReportId); }
function resetConclusion(){ const s=samples.find(x=>x.id===currentReportId); if(!s) return; s.conclusionManual=null; set(K_S,samples); openReport(currentReportId); }
function validateReport(){ const s=samples.find(x=>x.id===currentReportId); if(!s) return; s.validated=true; s.validatorDate=new Date().toISOString().slice(0,10); set(K_S,samples); openReport(currentReportId); }
function unvalidateReport(){ const s=samples.find(x=>x.id===currentReportId); if(!s) return; if(!confirm('Annuler la validation ?')) return; s.validated=false; set(K_S,samples); openReport(currentReportId); }

// Settings / logo
document.getElementById('st_logo').onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{
    settings.logo=r.result; set(K_T,settings);
    document.getElementById('st_logoPrev').src=r.result; document.getElementById('st_logoPrev').style.display='block';
    refreshHeader();
  }; r.readAsDataURL(f);
};
function saveSettings(){
  settings.name=document.getElementById('st_name').value.trim();
  settings.addr=document.getElementById('st_addr').value.trim();
  settings.phone=document.getElementById('st_phone').value.trim();
  settings.email=document.getElementById('st_email').value.trim();
  settings.auth=document.getElementById('st_auth').value.trim();
  set(K_T,settings); refreshHeader(); closeM('mSettings');
}

// CSV / backup / restore
document.getElementById('btnExport').onclick=()=>{
  const list=filtered();
  const head=['id','code','client','produit','service','facture','preleveur','reception','echeance','priorite','tests','notes','validated','conclusionManual'];
  const rows=[head.join(',')];
  list.forEach(s=>{
    const tests=(s.tests||[]).map(t=>(t.name||'')+':'+(t.result||'')+' '+(t.unit||'')+' ['+(t.ref||'')+']').join(' | ');
    const arr=[s.id,s.sampleCode,s.clientName,s.productType||'',s.serviceName||'',s.invoiceNumber||'',s.samplerType||'',s.receivedDate||'',s.dueDate||'',s.priority||'',tests,(s.notes||'').replaceAll('
',' '),String(!!s.validated),s.conclusionManual||''];
    rows.append(arr.map(v=> '"'+String(v || '').replaceAll('"','""')+'"' ).join(','));
  });
  const blob=new Blob([rows.join('
')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='qc_lab_v22_fix_'+new Date().toISOString().slice(0,10)+'.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
};
document.getElementById('btnBackup').onclick=()=>{
  const payload={version:'2.2-fix',exportedAt:new Date().toISOString(),settings,clients,samples,products};
  const def='qc_lab_backup_'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')+'.qclab.json';
  const name=prompt('Nom du fichier de sauvegarde :',def)||def;
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500);
};
function doRestore(){
  const f=document.getElementById('restoreFile').files[0]; if(!f){document.getElementById('restoreMsg').textContent='Aucun fichier';return;}
  const mode=document.getElementById('restoreMode').value;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);
      if(mode==='replace'){ settings=data.settings||settings; clients=data.clients||[]; samples=data.samples||[]; products=data.products||products; }
      else { settings={...settings,...(data.settings||{})}; clients=[...(clients||[]),...((data.clients)||[])]; samples=[...(samples||[]),...((data.samples)||[])]; products=[...(products||[]),...((data.products)||[])]; }
      set(K_T,settings); set(K_C,clients); set(K_S,samples); set(K_P,products);
      refreshHeader(); render(); document.getElementById('restoreMsg').textContent='Restauration OK'; setTimeout(()=>closeM('mRestore'),600);
    }catch(e){ document.getElementById('restoreMsg').textContent='Fichier invalide'; }
  };
  r.readAsText(f,'utf-8');
}

// Export Word
function exportWord(){
  const node = document.getElementById('printable'); if(!node){ alert('Aucun rapport à exporter'); return; }
  const pre = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><title>Rapport</title><style>body{font-family:Arial,Helvetica,sans-serif}table{border-collapse:collapse;width:100%}th,td{border:1px solid #000;padding:5px;font-size:11pt}.muted{color:#666}</style></head><body>';
  const post = '</body></html>';
  const html = pre + node.innerHTML + post;
  const url='data:application/vnd.ms-word;charset=utf-8,'+encodeURIComponent(html);
  const a = document.createElement('a'); a.href=url; a.download='rapport.doc'; document.body.appendChild(a); a.click(); a.remove();
}

// Init
populateClients(""); populateProducts("");
</script>
</body>
</html>
