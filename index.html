<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>QC Lab Lite v1.5 — OFFLINE</title>
<style>
  :root{--b:#e5e7eb;--t:#111827;--m:#6b7280}
  body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; margin:0; background:#f9fafb; color:var(--t)}
  .container{max-width:1200px; margin:0 auto; padding:16px}
  .card{background:#fff; border:1px solid var(--b); border-radius:14px; padding:16px}
  .input, select, textarea{width:100%; border:1px solid var(--b); border-radius:12px; padding:10px; outline:none}
  .input:focus, select:focus, textarea:focus{box-shadow:0 0 0 3px rgba(59,130,246,.2); border-color:#93c5fd}
  .btn{border:1px solid var(--b); border-radius:12px; padding:8px 12px; background:#fff; cursor:pointer}
  .btn-primary{background:#111827; color:#fff; border:none}
  .btn-ghost{background:transparent; border:1px solid transparent}
  .grid{display:grid; gap:12px}
  .g3{grid-template-columns:repeat(3,1fr)}
  .g2{grid-template-columns:repeat(2,1fr)}
  .g4{grid-template-columns:repeat(4,1fr)}
  table{width:100%; border-collapse:collapse}
  th,td{padding:10px; border-top:1px solid var(--b); text-align:left; font-size:14px; vertical-align:top}
  thead th{border-top:none; color:var(--m); font-weight:600}
  .chip{border:1px solid var(--b); border-radius:999px; padding:2px 10px; font-size:12px}
  .muted{color:var(--m); font-size:12px}
  header{position:sticky; top:0; background:#fff; border-bottom:1px solid var(--b); z-index:5}
  .modal-bg{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:50}
  .modal{background:#fff; border-radius:16px; border:1px solid var(--b); padding:16px; max-width:1100px; width:96vw; max-height:90vh; overflow:auto}
  .logoBox{border:1px solid var(--b); border-radius:10px; min-height:80px; min-width:260px; display:flex; align-items:center; justify-content:center}
  .labBox{border:2px solid #111827; border-radius:12px; padding:10px}
  .stamp{border:1px dashed #9ca3af; border-radius:12px; height:110px; display:flex; align-items:center; justify-content:center; font-size:12px; color:#6b7280}
  .list{border:1px solid var(--b); border-radius:12px; overflow:auto; max-height:50vh; background:#fff}
  .row{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-top:1px solid var(--b)}
  .row:first-child{border-top:none}
  .nc{background:#fee2e2} .nc td{border-top-color:#fecaca} .nc .txt{color:#b91c1c}
  .ok{background:#ecfdf5} .ok td{border-top-color:#d1fae5} .ok .txt{color:#065f46}
  @media print{
    header,.no-print{display:none !important}
    body{background:#fff}
    .card{border:none; padding:0}
    .nc{background:#fee2e2 !important}
    .ok{background:#ecfdf5 !important}
  }
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
    <div style="display:flex;align-items:center;gap:10px">
      <img id="labLogoSmall" alt="Logo" style="max-height:44px;max-width:200px;object-fit:contain"/>
      <div>
        <div style="font-size:22px;font-weight:700" id="labNameHdr">QC Lab Lite</div>
        <div class="muted" id="labMetaHdr"></div>
      </div>
    </div>
    <div class="no-print" style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnClients">Clients</button>
      <button class="btn" id="btnTests">Catalogue tests</button>
      <button class="btn" id="btnProd">Produits & services</button>
      <button class="btn" id="btnSettings">Identité labo</button>
      <button class="btn" id="btnExportCsv">Exporter CSV</button>
      <button class="btn" id="btnBackup">Sauvegarder</button>
      <button class="btn" id="btnRestore">Restaurer</button>
      <button class="btn btn-primary" id="btnNew">+ Nouvel échantillon</button>
    </div>
  </div>
</header>

<main class="container grid" style="gap:16px">
  <div class="grid g3">
    <div class="card"><div class="muted">Échantillons</div><div style="font-size:22px;font-weight:700" id="statTotal">0</div></div>
    <div class="card"><div class="muted">Échéance ≤ 48h</div><div style="font-size:22px;font-weight:700" id="statSoon">0</div></div>
    <div class="card"><div class="muted">Année courante</div><div style="font-size:22px;font-weight:700" id="statYear">0</div></div>
  </div>

  <div class="grid g3">
    <div>
      <div class="muted">Recherche</div>
      <input class="input" id="q" placeholder="Code, client, produit, service, facture"/>
    </div>
    <div>
      <div class="muted">Service</div>
      <select class="input" id="fService">
        <option>Tous</option>
        <option>Physico-chimie</option>
        <option>Microbiologie</option>
      </select>
    </div>
    <div>
      <div class="muted">Priorité</div>
      <select class="input" id="fPriority">
        <option>Toutes</option>
        <option>Normale</option><option>Urgente</option><option>Critique</option>
      </select>
    </div>
  </div>

  <div class="card" style="padding:0;overflow:auto">
    <table id="tbl">
      <thead>
        <tr><th>Code</th><th>Client</th><th>Produit/Service</th><th>N° facture</th><th>Préleveur</th><th>Réception</th><th>Échéance</th><th>Priorité</th><th class="no-print" style="text-align:right">Actions</th></tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</main>

<!-- Sample Modal -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:600" id="modalTitle">Nouvel échantillon</div>
      <button class="btn no-print" onclick="closeModal()">✕</button>
    </div>

    <form id="sampleForm">
      <div class="grid g3">
        <div><div class="muted">Code échantillon</div><input class="input" id="sf_code"/></div>
        <div>
          <div class="muted">Client</div>
          <div style="display:flex;gap:8px">
            <select class="input" id="sf_clientSelect" style="flex:1"></select>
            <button type="button" class="btn" onclick="openClients(true)">Nouveau</button>
          </div>
        </div>
        <div><div class="muted">Adresse client</div><input class="input" id="sf_clientAddr"/></div>

        <div>
          <div class="muted">Produit / Matrice</div>
          <select class="input" id="sf_productSelect"></select>
        </div>
        <div>
          <div class="muted">Service</div>
          <select class="input" id="sf_serviceSelect">
            <option value="">— Choisir —</option>
            <option>Physico-chimie</option>
            <option>Microbiologie</option>
          </select>
        </div>
        <div class="no-print" style="display:flex;align-items:flex-end;gap:8px">
          <button type="button" class="btn" onclick="loadServiceParams()">Charger paramètres du service</button>
        </div>

        <div><div class="muted">Nom commercial</div><input class="input" id="sf_brand"/></div>
        <div><div class="muted">Poids / Quantité</div><input class="input" id="sf_qty"/></div>
        <div><div class="muted">Température (°C)</div><input class="input" id="sf_temp"/></div>

        <div><div class="muted">Lieu de prélèvement</div><input class="input" id="sf_samplingLoc"/></div>
        <div><div class="muted">N° facture (optionnel)</div><input class="input" id="sf_invoice"/></div>
        <div><div class="muted">Préleveur</div>
          <select class="input" id="sf_sampler"><option>Client</option><option>Technicien labo</option></select>
        </div>
        <div><div class="muted">Réception</div><input type="date" class="input" id="sf_received"/></div>
        <div><div class="muted">Échéance</div><input type="date" class="input" id="sf_due"/></div>
        <div><div class="muted">Priorité</div>
          <select class="input" id="sf_priority"><option>Normale</option><option>Urgente</option><option>Critique</option></select>
        </div>
        <div style="grid-column:1 / span 3">
          <div class="muted">Notes</div>
          <textarea class="input" rows="2" id="sf_notes"></textarea>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div style="font-weight:600">Tests</div>
        <div class="no-print" style="display:flex;gap:8px">
          <button type="button" class="btn" onclick="openTestPicker()">Sélectionner des tests</button>
          <button type="button" class="btn" onclick="addTest()">+ Test libre</button>
        </div>
      </div>

      <div id="testsZone" class="grid" style="margin-top:8px"></div>

      <div id="err" style="color:#dc2626;font-size:12px;margin-top:8px"></div>

      <div class="no-print" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button type="button" class="btn-ghost" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<!-- Tests Picker -->
<div class="modal-bg" id="testsPickerBg">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:600">Sélection de tests</div>
      <button class="btn no-print" onclick="closeTestPicker()">✕</button>
    </div>
    <div class="list" id="testsPickerList"></div>
    <div class="no-print" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn" onclick="applyTestSelection()">Ajouter à l'échantillon</button>
    </div>
  </div>
</div>

<!-- Report Modal -->
<div class="modal-bg" id="reportBg">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:600">Rapport</div>
      <button class="btn no-print" onclick="closeReport()">✕</button>
    </div>

    <div class="grid g3 no-print" style="margin-bottom:10px">
      <div><div class="muted">Nom du valideur</div><input class="input" id="rv_name"/></div>
      <div><div class="muted">Fonction</div><input class="input" id="rv_role"/></div>
      <div><div class="muted">Date de validation</div><input type="date" class="input" id="rv_date"/></div>
    </div>

    <div id="reportPrintable">
      <div class="card labBox">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <div style="display:flex;align-items:center;gap:16px">
            <img id="labLogo" class="logo" style="max-height:90px;max-width:300px;object-fit:contain"/>
            <div>
              <div style="font-size:22px;font-weight:700" id="labName">Laboratoire Contrôle Qualité</div>
              <div class="muted" id="labMeta"></div>
              <div class="muted" id="labAuth"></div>
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:600;font-size:14px">Réf. rapport</div>
            <div class="muted" id="repRef"></div>
            <div class="muted" id="repDate"></div>
          </div>
        </div>
      </div>

      <div class="card" id="repSampleBox" style="border:2px solid #111827">
        <div style="font-weight:600;margin-bottom:6px">Échantillon</div>
        <div class="grid g3" id="repIdent"></div>
      </div>

      <div class="card" id="repResults"></div>
      <div class="card" id="repConclusion"></div>
      <div class="card" id="repNotes" style="display:none"></div>
      <div class="card">
        <div style="font-weight:600;margin-bottom:8px">Validation</div>
        <div class="grid g2">
          <div>
            <table style="width:100%;border-collapse:collapse">
              <tbody>
                <tr><td style="width:40%">Validé par</td><td id="vBy">—</td></tr>
                <tr><td>Fonction</td><td id="vRole">—</td></tr>
                <tr><td>Date</td><td id="vDate">—</td></tr>
              </tbody>
            </table>
          </div>
          <div class="stamp">Cachet & Signature</div>
        </div>
        <div class="muted" style="margin-top:8px">Ce rapport est validé conformément à la norme ISO/CEI 17025. Il ne peut être reproduit qu’en entier, sauf accord écrit du laboratoire.</div>
      </div>
    </div>

    <div class="no-print" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn" onclick="window.print()">Imprimer / PDF</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-bg" id="settingsBg">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:600">Paramètres – Identité du laboratoire</div>
      <button class="btn no-print" onclick="closeSettings()">✕</button>
    </div>
    <div class="grid g2">
      <div><div class="muted">Nom</div><input class="input" id="st_name" value="Laboratoire Contrôle Qualité"/></div>
      <div><div class="muted">N° autorisation ministérielle</div><input class="input" id="st_auth"/></div>
      <div><div class="muted">Adresse</div><input class="input" id="st_addr"/></div>
      <div><div class="muted">Téléphone</div><input class="input" id="st_phone"/></div>
      <div style="grid-column:1 / span 2"><div class="muted">Email</div><input class="input" id="st_email"/></div>
    </div>
    <div class="muted" style="margin-top:8px">Logo (PNG/JPG/SVG)</div>
    <input type="file" accept="image/*" id="st_logo"/>
    <div class="logoBox" style="margin-top:8px"><img id="st_logoPrev" style="max-height:90px;max-width:300px;object-fit:contain"/></div>
    <div class="no-print" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn" onclick="removeLogo()">Supprimer le logo</button>
      <button class="btn-ghost" onclick="closeSettings()">Annuler</button>
      <button class="btn btn-primary" onclick="saveSettings()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Clients Modal -->
<div class="modal-bg" id="clientsBg">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:600">Clients (base locale)</div>
      <button class="btn no-print" onclick="closeClients()">✕</button>
    </div>
    <div class="grid g3">
      <div><div class="muted">Nom *</div><input class="input" id="cl_name"/></div>
      <div><div class="muted">Adresse</div><input class="input" id="cl_addr"/></div>
      <div><div class="muted">Téléphone</div><input class="input" id="cl_phone"/></div>
      <div style="grid-column:1 / span 3"><div class="muted">Email</div><input class="input" id="cl_email"/></div>
    </div>
    <div class="no-print" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn" onclick="saveClient()">Enregistrer</button>
    </div>
    <div class="list" id="clientsList" style="margin-top:10px"></div>
  </div>
</div>

<!-- Tests Catalogue Modal -->
<div class="modal-bg" id="testsCatBg">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:600">Catalogue des tests (général)</div>
      <button class="btn no-print" onclick="closeTestsCat()">✕</button>
    </div>
    <div class="grid g3">
      <div><div class="muted">Nom *</div><input class="input" id="tc_name"/></div>
      <div><div class="muted">Unité</div><input class="input" id="tc_unit"/></div>
      <div><div class="muted">Référence</div><input class="input" id="tc_ref"/></div>
    </div>
    <div class="no-print" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn" onclick="saveTestCat()">Ajouter / Mettre à jour</button>
    </div>
    <div class="list" id="testsCatList" style="margin-top:10px"></div>
  </div>
</div>

<!-- Produits & Services Modal -->
<div class="modal-bg" id="prodBg">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:600">Produits & services</div>
      <button class="btn no-print" onclick="closeProd()">✕</button>
    </div>

    <div class="grid g3">
      <div><div class="muted">Produit *</div><input class="input" id="pr_name" placeholder="ex. Lait"/></div>
      <div><div class="muted">Service (fixe)</div>
        <select class="input" id="pr_service">
          <option>Physico-chimie</option>
          <option>Microbiologie</option>
        </select>
      </div>
      <div class="no-print" style="display:flex;align-items:flex-end"><button class="btn" onclick="addService()">Ajouter service</button></div>
    </div>

    <div class="grid g3" style="margin-top:8px">
      <div><div class="muted">Paramètre *</div><input class="input" id="pr_param_name" placeholder="ex. pH"/></div>
      <div><div class="muted">Unité</div><input class="input" id="pr_param_unit" placeholder=""/></div>
      <div><div class="muted">Référence</div><input class="input" id="pr_param_ref" placeholder="5.5–7.5, < 1.0, ≥ 80, etc."/></div>
      <div class="no-print" style="grid-column:1 / span 3;display:flex;justify-content:flex-end"><button class="btn" onclick="addParamToService()">Ajouter paramètre</button></div>
    </div>

    <div class="list" id="prodList" style="margin-top:10px"></div>
  </div>
</div>

<!-- Restore Modal -->
<div class="modal-bg" id="restoreBg">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:600">Restaurer une sauvegarde</div>
      <button class="btn no-print" onclick="closeRestore()">✕</button>
    </div>
    <div class="grid g3">
      <div style="grid-column:1 / span 3">
        <div class="muted">Fichier de sauvegarde (.qclab.json)</div>
        <input type="file" id="restoreFile" accept=".json,.qclab,.qclab.json"/>
      </div>
      <div>
        <div class="muted">Mode</div>
        <select class="input" id="restoreMode">
          <option value="replace">Remplacer (écrase la base)</option>
          <option value="merge">Fusionner (déduplication par id)</option>
        </select>
      </div>
    </div>
    <div id="restoreMsg" class="muted" style="margin-top:8px"></div>
    <div class="no-print" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn" onclick="doRestore()">Restaurer</button>
    </div>
  </div>
</div>

<footer class="muted" style="text-align:center;padding:10px">OFFLINE v1.5 — 2025-08-17T09:57:55.764049Z</footer>

<script>
// ===== Utilities =====
const uid = () => Math.random().toString(36).slice(2,10);
const todayISO = () => new Date().toISOString().slice(0,10);
const fmtDateFR = d => {
  if(!d) return "";
  const dt = new Date(d);
  const dd = String(dt.getDate()).padStart(2,'0');
  const mm = String(dt.getMonth()+1).padStart(2,'0');
  const yyyy = dt.getFullYear();
  return `${dd}/${mm}/${yyyy}`;
};

function parseNumber(x){ if(x==null) return null; const s=String(x).replace(',', '.'); const m=s.match(/-?\d+(?:\.\d+)?/); return m?parseFloat(m[0]):null; }
function checkConformity(result, ref){
  if(result==null || result==="") return null;
  if(!ref || !String(ref).trim()) return null;
  const r = parseNumber(result);
  if(r==null) return null;
  const refS = String(ref).replace(',', '.').trim();
  let m = refS.match(/(-?\d+(?:\.\d+)?)\s*[–-]\s*(-?\d+(?:\.\d+)?)/);
  if(m){ const a=parseFloat(m[1]), b=parseFloat(m[2]); if(isNaN(a)||isNaN(b)) return null; return (r>=Math.min(a,b) && r<=Math.max(a,b)); }
  m = refS.match(/^(?:<=|≤)\s*(-?\d+(?:\.\d+)?)/); if(m){ const v=parseFloat(m[1]); return r<=v; }
  m = refS.match(/^(?:>=|≥)\s*(-?\d+(?:\.\d+)?)/); if(m){ const v=parseFloat(m[1]); return r>=v; }
  m = refS.match(/^<\s*(-?\d+(?:\.\d+)?)/); if(m){ const v=parseFloat(m[1]); return r<v; }
  m = refS.match(/^>\s*(-?\d+(?:\.\d+)?)/); if(m){ const v=parseFloat(m[1]); return r>v; }
  m = refS.match(/^(?:=)?\s*(-?\d+(?:\.\d+)?)/); if(m){ const v=parseFloat(m[1]); return r===v; }
  return null;
}

// ===== Storage Keys =====
const K_SAMPLES = "qc_v15_samples";
const K_SETTINGS = "qc_v15_settings";
const K_CLIENTS = "qc_v15_clients";
const K_TESTCAT = "qc_v15_testcat";
const K_PRODUCTS = "qc_v15_products"; // products with services

// Migrate from v1.4 if first run
(function migrate(){
  try{
    const map = [
      ["qc_v14_samples", K_SAMPLES],
      ["qc_v14_settings", K_SETTINGS],
      ["qc_v14_clients", K_CLIENTS],
      ["qc_v14_testcat", K_TESTCAT],
      ["qc_v14_products", K_PRODUCTS]
    ];
    for(const [oldK,newK] of map){
      if(!localStorage.getItem(newK) && localStorage.getItem(oldK)){
        localStorage.setItem(newK, localStorage.getItem(oldK));
      }
    }
  }catch(e){}
})();

const readStore = (k, def) => { try{ const r = localStorage.getItem(k); return r? JSON.parse(r): def; }catch{ return def; } };
const writeStore = (k, v) => { try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };

// ===== Global state =====
let samples = readStore(K_SAMPLES, []);
let settings = readStore(K_SETTINGS, {name:"Laboratoire Contrôle Qualité", addr:"", phone:"", email:"", auth:"", logo:null});
let clients = readStore(K_CLIENTS, []);
let testCat = readStore(K_TESTCAT, []);
let products = readStore(K_PRODUCTS, []);

// ===== Header identity =====
function refreshHeader(){
  document.getElementById('labNameHdr').textContent = settings.name || "QC Lab Lite";
  const meta = [settings.addr, settings.phone, settings.email].filter(Boolean).join(' • ');
  document.getElementById('labMetaHdr').textContent = meta;
  const logo = document.getElementById('labLogoSmall');
  logo.src = settings.logo || "";
  logo.style.display = settings.logo? 'block':'none';
}
refreshHeader();

// ===== Filters & list =====
const rowsEl = document.getElementById('rows');
const qEl = document.getElementById('q');
const fServiceEl = document.getElementById('fService');
const fPriorityEl = document.getElementById('fPriority');
const statTotal = document.getElementById('statTotal');
const statSoon = document.getElementById('statSoon');
const statYear = document.getElementById('statYear');

function filtered(){
  const q = (qEl.value||"").toLowerCase().trim();
  const serv = fServiceEl.value;
  const p = fPriorityEl.value;
  return samples.filter(x=>{
    const hay = [x.sampleCode, x.clientName, x.productType, x.serviceName, x.invoiceNumber].map(v=> (v||"").toLowerCase());
    const mq = !q || hay.some(v=> v.includes(q));
    const ms = serv==="Tous" || x.serviceName===serv;
    const mp = p==="Toutes" || x.priority===p;
    return mq && ms && mp;
  });
}
function render(){
  const list = filtered();
  rowsEl.innerHTML = "";
  if(list.length===0){
    rowsEl.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#6b7280;padding:24px">Aucun échantillon</td></tr>';
  } else {
    for(const x of list){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${x.sampleCode||""}</td>
        <td>${x.clientName||""}</td>
        <td>${(x.productType||"") + (x.serviceName? " • "+x.serviceName:"")}</td>
        <td>${x.invoiceNumber||""}</td>
        <td>${x.samplerType||""}</td>
        <td>${fmtDateFR(x.receivedDate)}</td>
        <td>${fmtDateFR(x.dueDate)}</td>
        <td><span class="chip">${x.priority||""}</span></td>
        <td class="no-print" style="text-align:right">
          <button class="btn" onclick="openReport('${x.id}')">Rapport</button>
          <button class="btn" onclick="editSample('${x.id}')">Éditer</button>
          <button class="btn" onclick="delSample('${x.id}')">Supprimer</button>
        </td>
      `;
      rowsEl.appendChild(tr);
    }
  }
  statTotal.textContent = samples.length;
  const soon = samples.filter(x=> x.dueDate && new Date(x.dueDate) <= new Date(Date.now()+2*24*3600*1000)).length;
  statSoon.textContent = soon;
  const y = new Date().getFullYear();
  const inYear = samples.filter(x=> x.receivedDate && new Date(x.receivedDate).getFullYear()===y).length;
  statYear.textContent = inYear;
}
qEl.oninput = fServiceEl.onchange = fPriorityEl.onchange = render;
render();

// ===== Sample modal & CRUD =====
const modalBg = document.getElementById('modalBg');
const testsZone = document.getElementById('testsZone');
let editingId = null;

function populate(select, items, selectedId, labelFn){
  select.innerHTML = '<option value="">— Choisir —</option>' + items.map(x=> `<option value="${x.id}" ${selectedId===x.id?'selected':''}>${labelFn?labelFn(x):x.name}</option>`).join("");
}
function populateClientSelect(selectEl, selectedId){
  selectEl.innerHTML = '<option value="">— Choisir —</option>' + clients.map(c=> `<option value="${c.id}" ${selectedId===c.id?'selected':''}>${c.name}</option>`).join("");
}
function populateProductSelect(selectedProdId){
  const sel = document.getElementById('sf_productSelect');
  populate(sel, products, selectedProdId);
}

function onClientChange(){
  const sel = document.getElementById('sf_clientSelect');
  const c = clients.find(x=> x.id===sel.value);
  document.getElementById('sf_clientAddr').value = c? (c.addr||"") : "";
}

function loadServiceParams(){
  const prodId = document.getElementById('sf_productSelect').value;
  const service = document.getElementById('sf_serviceSelect').value;
  const prod = products.find(p=> p.id===prodId);
  const serv = prod? (prod.services||[]).find(s=> s.name===service) : null;
  if(!serv){ alert("Sélectionnez un produit et un service."); return; }
  testsZone.innerHTML = "";
  (serv.params||[]).forEach(t=> addTestRow({name:t.name, unit:t.unit||"", refRange:t.refRange||"", status:"Non commencé", result:""}));
}

function openModal(newItem){
  editingId = newItem? null: editingId;
  document.getElementById('modalTitle').textContent = editingId? "Modifier l'échantillon":"Nouvel échantillon";
  modalBg.style.display = 'flex';
  document.getElementById('err').textContent = "";
  const s = newItem ? {
    sampleCode:"", clientId:"", clientName:"", clientAddress:"", productType:"",
    productId:"", serviceName:"",
    brandName:"", quantity:"", temperature:"",
    samplingLocation:"", invoiceNumber:"", samplerType:"Client",
    receivedDate: todayISO(), dueDate:"", priority:"Normale",
    notes:"", tests:[]
  } : samples.find(x=> x.id===editingId);

  document.getElementById('sf_code').value = s.sampleCode||"";
  populateClientSelect(document.getElementById('sf_clientSelect'), s.clientId||"");
  document.getElementById('sf_clientAddr').value = s.clientAddress||"";
  populateProductSelect(s.productId||"");
  document.getElementById('sf_serviceSelect').value = s.serviceName || "";

  document.getElementById('sf_brand').value = s.brandName||"";
  document.getElementById('sf_qty').value = s.quantity||"";
  document.getElementById('sf_temp').value = s.temperature||"";

  document.getElementById('sf_samplingLoc').value = s.samplingLocation||"";
  document.getElementById('sf_invoice').value = s.invoiceNumber||"";
  document.getElementById('sf_sampler').value = s.samplerType||"Client";
  document.getElementById('sf_received').value = s.receivedDate||todayISO();
  document.getElementById('sf_due').value = s.dueDate||"";
  document.getElementById('sf_priority').value = s.priority||"Normale";
  document.getElementById('sf_notes').value = s.notes||"";
  testsZone.innerHTML = "";
  (s.tests||[]).forEach(addTestRow);

  document.getElementById('sf_clientSelect').onchange = ()=>{
    onClientChange();
    const c = clients.find(x=> x.id===document.getElementById('sf_clientSelect').value);
    document.getElementById('sf_clientAddr').value = c? (c.addr||"") : "";
  };
}
function closeModal(){ modalBg.style.display='none'; editingId=null; }
document.getElementById('btnNew').onclick = ()=>{ editingId=null; openModal(true); };

function addTestRow(t){
  const div = document.createElement('div');
  div.className = 'card';
  div.style.display = 'grid'; div.style.gridTemplateColumns = 'repeat(6,1fr)'; div.style.gap='8px';
  div.innerHTML = `
    <input class="input" placeholder="Nom du test" value="${t.name||""}" data-k="name"/>
    <input class="input" placeholder="Unité" value="${t.unit||""}" data-k="unit"/>
    <input class="input" placeholder="Plage de réf." value="${t.refRange||""}" data-k="refRange"/>
    <select class="input" data-k="status">
      ${['Non commencé','En cours','Terminé','Validé'].map(s=> `<option ${t.status===s?'selected':''}>${s}</option>`).join("")}
    </select>
    <input class="input" placeholder="Résultat" value="${t.result||""}" data-k="result"/>
    <div style="text-align:right"><button type="button" class="btn" onclick="this.parentElement.parentElement.remove()">Supprimer</button></div>
  `;
  testsZone.appendChild(div);
}
function addTest(){ addTestRow({name:"",unit:"",refRange:"",status:"Non commencé",result:""}); }

document.getElementById('sampleForm').onsubmit = (e)=>{
  e.preventDefault();
  const selId = document.getElementById('sf_clientSelect').value;
  const client = clients.find(x=> x.id===selId);
  const prodId = document.getElementById('sf_productSelect').value;
  const prod = products.find(p=> p.id===prodId);
  const serviceName = document.getElementById('sf_serviceSelect').value;
  const v = {
    sampleCode: document.getElementById('sf_code').value.trim(),
    clientId: selId || "",
    clientName: client? client.name : "",
    clientAddress: document.getElementById('sf_clientAddr').value.trim(),
    productType: prod? prod.name : "",
    productId: prodId || "",
    serviceName: serviceName || "",
    brandName: document.getElementById('sf_brand').value.trim(),
    quantity: document.getElementById('sf_qty').value.trim(),
    temperature: document.getElementById('sf_temp').value.trim(),
    samplingLocation: document.getElementById('sf_samplingLoc').value.trim(),
    invoiceNumber: document.getElementById('sf_invoice').value.trim(),
    samplerType: document.getElementById('sf_sampler').value,
    receivedDate: document.getElementById('sf_received').value,
    dueDate: document.getElementById('sf_due').value,
    priority: document.getElementById('sf_priority').value,
    notes: document.getElementById('sf_notes').value,
    tests: Array.from(document.querySelectorAll('#testsZone .card')).map(row=>{
      const obj = {};
      row.querySelectorAll('[data-k]').forEach(inp=> obj[inp.getAttribute('data-k')] = inp.value);
      return obj;
    })
  };
  if(editingId){ samples = samples.map(x=> x.id===editingId? {...x, ...v}: x); }
  else { samples = [{id: uid(), ...v}, ...samples]; }
  writeStore(K_SAMPLES, samples);
  render(); closeModal();
};

function editSample(id){ editingId = id; openModal(false); }
function delSample(id){ if(!confirm("Supprimer cet échantillon ?")) return; samples = samples.filter(x=> x.id!==id); writeStore(K_SAMPLES, samples); render(); }

// ===== Test Picker (from general catalogue) =====
const testsPickerBg = document.getElementById('testsPickerBg');
const testsPickerList = document.getElementById('testsPickerList');
function openTestPicker(){
  testsPickerBg.style.display='flex';
  testsPickerList.innerHTML = (testCat||[]).map(t=> `
    <div class="row"><label style="display:flex;align-items:center;gap:8px">
      <input type="checkbox" value="${t.id}"/> <b>${t.name}</b> <span class="muted">${t.unit||""} ${t.refRange?('• '+t.refRange):''}</span>
    </label>
    </div>
  `).join("") || '<div class="row">Catalogue vide</div>';
}
function closeTestPicker(){ testsPickerBg.style.display='none'; }
function applyTestSelection(){
  const ids = Array.from(testsPickerList.querySelectorAll('input[type=checkbox]:checked')).map(x=> x.value);
  const chosen = (testCat||[]).filter(t=> ids.includes(t.id));
  chosen.forEach(t=> addTestRow({name:t.name, unit:t.unit||"", refRange:t.refRange||"", status:"Non commencé", result:""}));
  closeTestPicker();
}

// ===== Report modal & global conclusion + numbering per service =====
const reportBg = document.getElementById('reportBg');

function computeReportNumber(sample){
  const year = sample.receivedDate ? new Date(sample.receivedDate).getFullYear() : new Date().getFullYear();
  const prefix = (sample.serviceName==="Physico-chimie") ? "PH" : (sample.serviceName==="Microbiologie" ? "MC" : "XX");
  const sameServiceSameYear = samples
    .filter(x=> (x.serviceName===sample.serviceName) && x.receivedDate && (new Date(x.receivedDate).getFullYear()===year))
    .sort((a,b)=> new Date(a.receivedDate) - new Date(b.receivedDate));
  let index = 1;
  for(const s of sameServiceSameYear){
    if(s.id===sample.id) break;
    index++;
  }
  const nnn = String(index).padStart(3,'0');
  return `${prefix}-${nnn}/${year}`;
}

function openReport(id){
  const s = samples.find(x=> x.id===id); if(!s) return;
  reportBg.style.display = 'flex';
  document.getElementById('rv_name').value = "";
  document.getElementById('rv_role').value = "";
  document.getElementById('rv_date').value = todayISO();
  document.getElementById('labLogo').src = settings.logo || ""; document.getElementById('labLogo').style.display = settings.logo? 'block':'none';
  document.getElementById('labName').textContent = settings.name || "Laboratoire Contrôle Qualité";
  document.getElementById('labMeta').textContent = [settings.addr, settings.phone, settings.email].filter(Boolean).join(' • ');
  document.getElementById('labAuth').textContent = settings.auth? "Autorisation ministérielle : " + settings.auth : "";
  document.getElementById('repRef').textContent = computeReportNumber(s);
  document.getElementById('repDate').textContent = "Émis le " + fmtDateFR(new Date());

  const ident = document.getElementById('repIdent');
  ident.innerHTML = `
    <div><div class="muted">Client</div><div style="font-weight:500">${s.clientName||""}</div></div>
    <div><div class="muted">Produit / Service</div><div style="font-weight:500">${(s.productType||"") + (s.serviceName? " • "+s.serviceName:"")}</div></div>
    <div><div class="muted">Nom commercial</div><div style="font-weight:500">${s.brandName||"—"}</div></div>
    <div><div class="muted">Poids / Quantité</div><div style="font-weight:500">${s.quantity||"—"}</div></div>
    <div><div class="muted">Température (°C)</div><div style="font-weight:500">${s.temperature||"—"}</div></div>
    <div><div class="muted">Préleveur</div><div style="font-weight:500">${s.samplerType||"—"}</div></div>
    <div><div class="muted">Lieu de prélèvement</div><div style="font-weight:500">${s.samplingLocation||"—"}</div></div>
    <div><div class="muted">N° facture</div><div style="font-weight:500">${s.invoiceNumber||"—"}</div></div>
    <div><div class="muted">Réception / Échéance</div><div style="font-weight:500">${fmtDateFR(s.receivedDate)} • ${fmtDateFR(s.dueDate)}</div></div>
  `;

  const res = document.getElementById('repResults');
  res.innerHTML = '<div style="font-weight:600;margin-bottom:8px">Résultats</div><table style="width:100%;border-collapse:collapse"><thead><tr><th>Test</th><th>Résultat</th><th>Unité</th><th>Référence</th><th>Conformité</th><th>Statut</th></tr></thead><tbody id="repResT"></tbody></table>';
  const tb = document.getElementById('repResT');
  let total=0, ok=0, nc=0, na=0;
  (s.tests||[]).forEach(t=>{
    const conf = checkConformity(t.result, t.refRange);
    const isNC = (conf===false);
    const tr = document.createElement('tr');
    if(isNC) tr.className = 'nc';
    const confTxt = conf===null ? '—' : (conf ? 'Conforme' : 'Non conforme');
    tr.innerHTML = `<td>${t.name||""}</td><td>${t.result||""}</td><td>${t.unit||""}</td><td>${t.refRange||""}</td><td class="txt">${confTxt}${isNC?' ⚠︎':''}</td><td>${t.status||""}</td>`;
    tb.appendChild(tr);
    total++;
    if(conf===true) ok++; else if(conf===false) nc++; else na++;
  });

  const concl = document.getElementById('repConclusion');
  const rule = "Règle de décision : conforme si tous les paramètres évaluables sont dans leur tolérance.";
  let text="", cls=""; 
  if(total===0 || ok+nc===0){ text = "Conformité non évaluée (références manquantes ou aucun paramètre)."; cls=""; }
  else if(nc>0){ text = "❌ Échantillon NON CONFORME (paramètres hors tolérance)."; cls="nc"; }
  else { text = "✅ Échantillon CONFORME (tous les paramètres évalués sont conformes)."; cls="ok"; }
  concl.innerHTML = `<div style="font-weight:600;margin-bottom:6px">Conclusion</div>
  <div class="${cls} card" style="padding:10px">
    <div>${text}</div>
    <div class="muted" style="margin-top:6px">${rule} • Synthèse : ${ok} conforme(s), ${nc} non conforme(s), ${na} non évalué(s).</div>
  </div>`;

  const notesCard = document.getElementById('repNotes');
  if(s.notes){
    notesCard.style.display = 'block';
    notesCard.innerHTML = '<div style="font-weight:600;margin-bottom:6px">Observations</div><div style="font-size:14px;white-space:pre-wrap">'+ s.notes +'</div>';
  }else{ notesCard.style.display = 'none'; }
  ['rv_name','rv_role','rv_date'].forEach(id=>{
    document.getElementById(id).oninput = ()=>{
      document.getElementById('vBy').textContent = document.getElementById('rv_name').value || '—';
      document.getElementById('vRole').textContent = document.getElementById('rv_role').value || '—';
      document.getElementById('vDate').textContent = fmtDateFR(document.getElementById('rv_date').value);
    };
  });
}
function closeReport(){ reportBg.style.display='none'; }

// ===== Settings, Clients, Tests Catalogue =====
const settingsBg = document.getElementById('settingsBg');
document.getElementById('btnSettings').onclick = ()=>{
  settingsBg.style.display='flex';
  document.getElementById('st_name').value = settings.name||"";
  document.getElementById('st_addr').value = settings.addr||"";
  document.getElementById('st_phone').value = settings.phone||"";
  document.getElementById('st_email').value = settings.email||"";
  document.getElementById('st_auth').value = settings.auth||"";
  const prev = document.getElementById('st_logoPrev'); prev.src = settings.logo||""; prev.style.display = settings.logo? 'block':'none';
};
function closeSettings(){ settingsBg.style.display='none'; }
function removeLogo(){ settings.logo=null; document.getElementById('st_logoPrev').style.display='none'; }
document.getElementById('st_logo').onchange = (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=>{ settings.logo = r.result; document.getElementById('st_logoPrev').src = r.result; document.getElementById('st_logoPrev').style.display='block'; };
  r.readAsDataURL(f);
};
function saveSettings(){
  settings.name = document.getElementById('st_name').value.trim();
  settings.addr = document.getElementById('st_addr').value.trim();
  settings.phone = document.getElementById('st_phone').value.trim();
  settings.email = document.getElementById('st_email').value.trim();
  settings.auth = document.getElementById('st_auth').value.trim();
  writeStore(K_SETTINGS, settings);
  closeSettings(); refreshHeader();
}

// Clients
const clientsBg = document.getElementById('clientsBg');
let editingClientId = null;
document.getElementById('btnClients').onclick = ()=> openClients(false);
function openClients(selectAfterCreate){
  clientsBg.style.display='flex';
  document.getElementById('cl_name').value = "";
  document.getElementById('cl_addr').value = "";
  document.getElementById('cl_phone').value = "";
  document.getElementById('cl_email').value = "";
  editingClientId = null;
  renderClientsList(selectAfterCreate);
}
function renderClientsList(selectAfterCreate){
  const list = document.getElementById('clientsList');
  list.innerHTML = clients.map(c=>`
    <div class="row">
      <div><b>${c.name}</b> <span class="muted">• ${c.addr||""} ${c.phone?("• "+c.phone):""} ${c.email?("• "+c.email):""}</span></div>
      <div>
        <button class="btn" onclick="editClient('${c.id}')">Éditer</button>
        <button class="btn" onclick="delClient('${c.id}')">Supprimer</button>
      </div>
    </div>
  `).join("") || '<div class="row">Aucun client</div>';
  if(selectAfterCreate && clients.length){
    const last = clients[clients.length-1];
    if(document.getElementById('sf_clientSelect')){
      populateClientSelect(document.getElementById('sf_clientSelect'), last.id);
      document.getElementById('sf_clientAddr').value = last.addr||"";
    }
  }else{
    if(document.getElementById('sf_clientSelect')) populateClientSelect(document.getElementById('sf_clientSelect'), document.getElementById('sf_clientSelect').value);
  }
}
function closeClients(){ clientsBg.style.display='none'; }
function saveClient(){
  const n = document.getElementById('cl_name').value.trim();
  if(!n){ alert("Nom client obligatoire"); return; }
  const v = { name:n, addr: document.getElementById('cl_addr').value.trim(), phone: document.getElementById('cl_phone').value.trim(), email: document.getElementById('cl_email').value.trim() };
  if(editingClientId){ clients = clients.map(c=> c.id===editingClientId? {...c, ...v}: c); }
  else { clients = [...clients, {id: uid(), ...v}]; }
  writeStore(K_CLIENTS, clients);
  renderClientsList(true);
  if(!editingClientId){ document.getElementById('cl_name').value=""; document.getElementById('cl_addr').value=""; document.getElementById('cl_phone').value=""; document.getElementById('cl_email').value=""; }
  editingClientId = null;
}
function editClient(id){
  const c = clients.find(x=> x.id===id); if(!c) return;
  editingClientId = id;
  document.getElementById('cl_name').value = c.name||"";
  document.getElementById('cl_addr').value = c.addr||"";
  document.getElementById('cl_phone').value = c.phone||"";
  document.getElementById('cl_email').value = c.email||"";
}
function delClient(id){
  if(!confirm("Supprimer ce client ?")) return;
  clients = clients.filter(x=> x.id!==id);
  writeStore(K_CLIENTS, clients);
  renderClientsList(false);
}

// Tests Catalogue (général)
const testsCatBg = document.getElementById('testsCatBg');
let editingTestId = null;
document.getElementById('btnTests').onclick = ()=> openTestsCat();
function openTestsCat(){
  testsCatBg.style.display='flex';
  document.getElementById('tc_name').value = "";
  document.getElementById('tc_unit'). value = "";
  document.getElementById('tc_ref').value = "";
  editingTestId = null;
  renderTestsCatList();
}
function renderTestsCatList(){
  const list = document.getElementById('testsCatList');
  list.innerHTML = (testCat||[]).map(t=>`
    <div class="row">
      <div><b>${t.name}</b> <span class="muted">• ${t.unit||""} ${t.refRange?("• "+t.refRange):""}</span></div>
      <div>
        <button class="btn" onclick="editTestCat('${t.id}')">Éditer</button>
        <button class="btn" onclick="delTestCat('${t.id}')">Supprimer</button>
      </div>
    </div>
  `).join("") || '<div class="row">Catalogue vide</div>';
}
function closeTestsCat(){ testsCatBg.style.display='none'; }
function saveTestCat(){
  const name = document.getElementById('tc_name').value.trim();
  if(!name){ alert("Nom du test obligatoire"); return; }
  const v = {name, unit: document.getElementById('tc_unit').value.trim(), refRange: document.getElementById('tc_ref').value.trim(), id: editingTestId || uid()};
  if(editingTestId){ testCat = testCat.map(t=> t.id===editingTestId? {...t, ...v}: t); }
  else { testCat = [...(testCat||[]), v]; }
  writeStore(K_TESTCAT, testCat); renderTestsCatList();
  editingTestId = null;
  document.getElementById('tc_name').value = ""; document.getElementById('tc_unit').value=""; document.getElementById('tc_ref').value="";
}
function editTestCat(id){
  const t = (testCat||[]).find(x=> x.id===id); if(!t) return;
  editingTestId = id;
  document.getElementById('tc_name').value = t.name||"";
  document.getElementById('tc_unit').value = t.unit||"";
  document.getElementById('tc_ref').value = t.refRange||"";
}
function delTestCat(id){
  if(!confirm("Supprimer ce test du catalogue ?")) return;
  testCat = (testCat||[]).filter(x=> x.id!==id);
  writeStore(K_TESTCAT, testCat); renderTestsCatList();
}

// ===== Products & Services =====
const prodBg = document.getElementById('prodBg');
document.getElementById('btnProd').onclick = ()=> openProd();
function openProd(){
  prodBg.style.display='flex';
  renderProdList();
}
function closeProd(){ prodBg.style.display='none'; }

function ensureProduct(name){
  let prod = products.find(p=> p.name.toLowerCase()===name.toLowerCase());
  if(!prod){ prod = {id: uid(), name, services: []}; products.push(prod); }
  return prod;
}
function ensureService(prod, servName){
  let serv = (prod.services||[]).find(s=> s.name===servName);
  if(!serv){ serv = {id: uid(), name: servName, params: []}; prod.services.push(serv); }
  return serv;
}
function addService(){
  const prodName = document.getElementById('pr_name').value.trim();
  const servName = document.getElementById('pr_service').value;
  if(!prodName){ alert("Produit obligatoire."); return; }
  const prod = ensureProduct(prodName);
  ensureService(prod, servName);
  writeStore(K_PRODUCTS, products); renderProdList();
}
function addParamToService(){
  const prodName = document.getElementById('pr_name').value.trim();
  const servName = document.getElementById('pr_service').value;
  const pname = document.getElementById('pr_param_name').value.trim();
  if(!prodName || !pname){ alert("Produit et paramètre sont obligatoires."); return; }
  const unit = document.getElementById('pr_param_unit').value.trim();
  const ref = document.getElementById('pr_param_ref').value.trim();
  const prod = ensureProduct(prodName);
  const serv = ensureService(prod, servName);
  serv.params.push({id: uid(), name: pname, unit: unit, refRange: ref});
  writeStore(K_PRODUCTS, products); renderProdList();
  document.getElementById('pr_param_name').value=""; document.getElementById('pr_param_unit').value=""; document.getElementById('pr_param_ref').value="";
}

function renderProdList(){
  const list = document.getElementById('prodList');
  list.innerHTML = (products||[]).map(p=>`
    <div class="row">
      <div><b>${p.name}</b> <span class="muted">(${(p.services||[]).length} service(s))</span></div>
      <div></div>
    </div>
    ${(p.services||[]).map(sv=>`
      <div class="row" style="padding-left:28px">
        <div><b>${sv.name}</b> <span class="muted">• ${sv.params.length} paramètre(s)</span></div>
        <div>
          <button class="btn" onclick="delService('${p.id}','${sv.id}')">Supprimer service</button>
        </div>
      </div>
      ${(sv.params||[]).map(t=>`
        <div class="row" style="padding-left:56px">
          <div>${t.name} <span class="muted">• ${t.unit||""} ${t.refRange?("• "+t.refRange):""}</span></div>
          <div><button class="btn" onclick="delParam('${p.id}','${sv.id}','${t.id}')">Supprimer</button></div>
        </div>
      `).join("")}
    `).join("")}
  `).join("") || '<div class="row">Aucun produit</div>';
}
function delParam(pid, sid, tid){
  const p = products.find(x=> x.id===pid); if(!p) return;
  const sv = (p.services||[]).find(x=> x.id===sid); if(!sv) return;
  sv.params = (sv.params||[]).filter(x=> x.id!==tid);
  writeStore(K_PRODUCTS, products); renderProdList();
}
function delService(pid, sid){
  const p = products.find(x=> x.id===pid); if(!p) return;
  p.services = (p.services||[]).filter(x=> x.id!==sid);
  writeStore(K_PRODUCTS, products); renderProdList();
}

// ===== Backup / Restore =====
document.getElementById('btnBackup').onclick = ()=>{
  const payload = {
    version:"1.5",
    exportedAt: new Date().toISOString(),
    settings, clients, testCat, samples, products
  };
  const def = `qc_lab_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.qclab.json`;
  const name = prompt("Nom du fichier de sauvegarde :", def) || def;
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 500);
};

const restoreBg = document.getElementById('restoreBg');
document.getElementById('btnRestore').onclick = ()=>{ restoreBg.style.display='flex'; document.getElementById('restoreMsg').textContent=""; document.getElementById('restoreFile').value=""; };

function closeRestore(){ restoreBg.style.display='none'; }

function dedupById(arr){
  const map = new Map();
  for(const x of arr || []){ if(!x || !x.id){ continue; } if(!map.has(x.id)) map.set(x.id, x); else map.set(x.id, {...map.get(x.id), ...x}); }
  return Array.from(map.values());
}

function doRestore(){
  const f = document.getElementById('restoreFile').files[0];
  if(!f){ document.getElementById('restoreMsg').textContent="Aucun fichier sélectionné."; return; }
  const mode = document.getElementById('restoreMode').value;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const data = JSON.parse(r.result);
      if(mode==="replace"){
        settings = data.settings || settings;
        clients = data.clients || [];
        testCat = data.testCat || [];
        samples = data.samples || [];
        products = data.products || [];
      }else{
        settings = {...settings, ...(data.settings||{})};
        clients = dedupById([...(clients||[]), ...((data.clients)||[])]);
        testCat = dedupById([...(testCat||[]), ...((data.testCat)||[])]);
        samples = dedupById([...(samples||[]), ...((data.samples)||[])]);
        products = dedupById([...(products||[]), ...((data.products)||[])]);
      }
      writeStore(K_SETTINGS, settings);
      writeStore(K_CLIENTS, clients);
      writeStore(K_TESTCAT, testCat);
      writeStore(K_SAMPLES, samples);
      writeStore(K_PRODUCTS, products);
      refreshHeader(); render();
      document.getElementById('restoreMsg').textContent = "Restauration terminée.";
      setTimeout(()=> closeRestore(), 500);
    }catch(e){
      document.getElementById('restoreMsg').textContent = "Fichier invalide.";
    }
  };
  r.readAsText(f, "utf-8");
}

// ===== Export CSV (liste filtrée) =====
document.getElementById('btnExportCsv').onclick = ()=>{
  const list = filtered();
  const headers = ["id","code","client","produit","service","nom_commercial","quantite","temperature","facture","preleveur","reception","echeance","priorite","tests","notes"];
  const rows = [headers.join(",")];
  for(const s of list){
    const tests = (s.tests||[]).map(t=> `${t.name||""}:${t.result||""} ${t.unit||""}`).join(" | ");
    const arr = [s.id, s.sampleCode, s.clientName, s.productType||"", s.serviceName||"", s.brandName||"", s.quantity||"", s.temperature||"", s.invoiceNumber||"", s.samplerType, s.receivedDate, s.dueDate, s.priority, tests, (s.notes||"").replaceAll(/\n|\r/g," ")];
    rows.push(arr.map(v=> `"${(v??"").toString().replaceAll('"','""')}"`).join(","));
  }
  const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = "qc_lab_v15_"+new Date().toISOString().slice(0,10)+".csv"; a.click();
  setTimeout(()=> URL.revokeObjectURL(url), 500);
};

// ===== Click-away to close modals =====
document.getElementById('modalBg').addEventListener('click', e=>{ if(e.target.id==='modalBg') closeModal(); });
document.getElementById('reportBg').addEventListener('click', e=>{ if(e.target.id==='reportBg') closeReport(); });
document.getElementById('settingsBg').addEventListener('click', e=>{ if(e.target.id==='settingsBg') closeSettings(); });
document.getElementById('clientsBg').addEventListener('click', e=>{ if(e.target.id==='clientsBg') closeClients(); });
document.getElementById('testsPickerBg').addEventListener('click', e=>{ if(e.target.id==='testsPickerBg') closeTestPicker(); });
document.getElementById('testsCatBg').addEventListener('click', e=>{ if(e.target.id==='testsCatBg') closeTestsCat(); });
document.getElementById('prodBg').addEventListener('click', e=>{ if(e.target.id==='prodBg') closeProd(); });
document.getElementById('restoreBg').addEventListener('click', e=>{ if(e.target.id==='restoreBg') closeRestore(); });
</script>
</body>
</html>
